[
  {
    "id": "06.3-sql-recipe-library-0",
    "originalQuery": "SELECT \n  pe.PAT_ENC_CSN_ID,\n  DATE(pe.CONTACT_DATE) as visit_date,\n  dep.DEPARTMENT_NAME,\n  ser.PROV_NAME as visit_provider,\n  -- Calculate days since last visit using LAG\n  julianday(pe.CONTACT_DATE) - \n    LAG(julianday(pe.CONTACT_DATE)) OVER (\n      PARTITION BY pe.PAT_ID \n      ORDER BY pe.CONTACT_DATE\n    ) as days_since_last_visit\nFROM PAT_ENC pe\nLEFT JOIN CLARITY_DEP dep ON pe.DEPARTMENT_ID = dep.DEPARTMENT_ID\nLEFT JOIN CLARITY_SER ser ON pe.VISIT_PROV_ID = ser.PROV_ID\nWHERE pe.PAT_ID = 'Z7004242'\nORDER BY pe.CONTACT_DATE DESC\nLIMIT 20;",
    "description": "View patient encounter history with department and provider",
    "chapterId": "06.3-sql-recipe-library",
    "index": 0,
    "results": [
      {
        "PAT_ENC_CSN_ID": 837844366,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "LOUGH, KAREN L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "RAMMELKAMP, ZOE L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1028739468,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "RAMMELKAMP, ZOE L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "visit_provider": "MAC LAB APL",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1028766353,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "RAMMELKAMP, ZOE L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 787137346,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1028606559,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1027863229,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 962603110,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 898794674,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 840888730,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 839256727,
        "visit_date": null,
        "DEPARTMENT_NAME": "GENERIC EXTERNAL DATA DEPARTMENT",
        "visit_provider": "GENERIC EXTERNAL DATA PROVIDER",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "DHILLON, PUNEET S",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 724619887,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL BUSINESS SERVICES",
        "visit_provider": "DHILLON, PUNEET S",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 724623985,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "DHILLON, PUNEET S",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 724628999,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "visit_provider": "MAC LAB APL",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 1018439080,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "visit_provider": null,
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "RAMMELKAMP, ZOE L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 958134730,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "visit_provider": "RAMMELKAMP, ZOE L",
        "days_since_last_visit": null
      },
      {
        "PAT_ENC_CSN_ID": 958147754,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "visit_provider": "MAC LAB APL",
        "days_since_last_visit": null
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "visit_date",
      "DEPARTMENT_NAME",
      "visit_provider",
      "days_since_last_visit"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-1",
    "originalQuery": "SELECT \n  pe.PAT_ENC_CSN_ID,\n  DATE(pe.CONTACT_DATE) as visit_date,\n  dx.LINE,\n  dx.PRIMARY_DX_YN,\n  edg.DX_NAME\nFROM PAT_ENC pe\nJOIN PAT_ENC_DX dx ON pe.PAT_ENC_CSN_ID = dx.PAT_ENC_CSN_ID\nJOIN CLARITY_EDG edg ON dx.DX_ID = edg.DX_ID\nWHERE pe.PAT_ID = 'Z7004242'\n  AND edg.DX_NAME IS NOT NULL\nORDER BY pe.CONTACT_DATE DESC, dx.PRIMARY_DX_YN DESC, dx.LINE;",
    "description": "Show encounter diagnoses with primary diagnosis first",
    "chapterId": "06.3-sql-recipe-library",
    "index": 1,
    "results": [
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "LINE": 3,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Screening for hyperlipidemia"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Screening for diabetes mellitus"
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Screening for diabetes mellitus"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Screening for hyperlipidemia"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "visit_date": null,
        "LINE": 3,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "LINE": 4,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 724628999,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "visit_date": null,
        "LINE": 3,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Dyspepsia"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Primary hypertension"
      },
      {
        "PAT_ENC_CSN_ID": 958147754,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Primary hypertension"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "visit_date": null,
        "LINE": 3,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified"
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Dyspepsia"
      },
      {
        "PAT_ENC_CSN_ID": 832464108,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829995922,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829467718,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829393933,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829393933,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Post-concussion headache"
      },
      {
        "PAT_ENC_CSN_ID": 829213099,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 958148810,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 921952141,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Late effect of traumatic injury to brain"
      },
      {
        "PAT_ENC_CSN_ID": 988126821,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 1043034397,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 977858467,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 974614965,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "visit_date": null,
        "LINE": 1,
        "PRIMARY_DX_YN": "Y",
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "visit_date": null,
        "LINE": 2,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Lipoma of head"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "visit_date": null,
        "LINE": 3,
        "PRIMARY_DX_YN": "N",
        "DX_NAME": "Nevus"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "visit_date",
      "LINE",
      "PRIMARY_DX_YN",
      "DX_NAME"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-2",
    "originalQuery": "WITH provider_appts AS (\n  SELECT \n    ser.PROV_ID,\n    ser.PROV_NAME,\n    CASE CAST(strftime('%w', pe.CONTACT_DATE) AS INTEGER)\n      WHEN 0 THEN 'Sunday'\n      WHEN 1 THEN 'Monday'\n      WHEN 2 THEN 'Tuesday'\n      WHEN 3 THEN 'Wednesday'\n      WHEN 4 THEN 'Thursday'\n      WHEN 5 THEN 'Friday'\n      WHEN 6 THEN 'Saturday'\n    END as day_of_week,\n    COUNT(*) as appt_count\n  FROM PAT_ENC pe\n  JOIN CLARITY_SER ser ON pe.VISIT_PROV_ID = ser.PROV_ID\n  WHERE pe.CONTACT_DATE >= date('now', '-1 year')\n    AND ser.PROV_NAME IS NOT NULL\n  GROUP BY ser.PROV_ID, ser.PROV_NAME, day_of_week\n)\nSELECT \n  PROV_NAME,\n  day_of_week,\n  appt_count\nFROM provider_appts\nWHERE appt_count > 0\nORDER BY PROV_NAME, \n  CASE day_of_week\n    WHEN 'Monday' THEN 1\n    WHEN 'Tuesday' THEN 2\n    WHEN 'Wednesday' THEN 3\n    WHEN 'Thursday' THEN 4\n    WHEN 'Friday' THEN 5\n    WHEN 'Saturday' THEN 6\n    WHEN 'Sunday' THEN 7\n  END;",
    "description": "Provider appointment patterns by day of week",
    "chapterId": "06.3-sql-recipe-library",
    "index": 2,
    "results": [
      {
        "PROV_NAME": "BUDZBAN, NICOLE L",
        "day_of_week": null,
        "appt_count": 1
      },
      {
        "PROV_NAME": "DHILLON, PUNEET S",
        "day_of_week": null,
        "appt_count": 4
      },
      {
        "PROV_NAME": "GENERIC EXTERNAL DATA PROVIDER",
        "day_of_week": null,
        "appt_count": 2
      },
      {
        "PROV_NAME": "GILMOUR, AARON K",
        "day_of_week": null,
        "appt_count": 2
      },
      {
        "PROV_NAME": "LOUGH, KAREN L",
        "day_of_week": null,
        "appt_count": 3
      },
      {
        "PROV_NAME": "MAC LAB APL",
        "day_of_week": null,
        "appt_count": 4
      },
      {
        "PROV_NAME": "PEPIN, PAMELA A",
        "day_of_week": null,
        "appt_count": 1
      },
      {
        "PROV_NAME": "PICONE, MARY A",
        "day_of_week": null,
        "appt_count": 6
      },
      {
        "PROV_NAME": "RAMMELKAMP, ZOE L",
        "day_of_week": null,
        "appt_count": 8
      },
      {
        "PROV_NAME": "WHITTINGTON, THERESA C",
        "day_of_week": null,
        "appt_count": 1
      },
      {
        "PROV_NAME": "WILD, DAWN M",
        "day_of_week": null,
        "appt_count": 1
      }
    ],
    "columns": [
      "PROV_NAME",
      "day_of_week",
      "appt_count"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-3",
    "originalQuery": "SELECT \n  om.ORDER_MED_ID,\n  cm.GENERIC_NAME_ as medication,\n  om.HV_DISCRETE_DOSE as dose,\n  om.REFILLS,\n  om.QUANTITY,\n  DATE(om.START_DATE) as start_date,\n  DATE(om.END_DATE) as end_date,\n  om.ORDER_STATUS_C_NAME as status\nFROM ORDER_MED om\nJOIN CLARITY_MEDICATION cm ON om.MEDICATION_ID = cm.MEDICATION_ID\nWHERE om.PAT_ID = 'Z7004242'\n  AND om.ORDER_STATUS_C_NAME NOT IN ('Canceled', 'Discontinued')\nORDER BY om.START_DATE DESC;",
    "description": "List active medications with generic names and instructions",
    "chapterId": "06.3-sql-recipe-library",
    "index": 3,
    "results": [
      {
        "ORDER_MED_ID": 772179261,
        "medication": "Lisinopril Tab 10 MG",
        "dose": 10,
        "REFILLS": 1,
        "QUANTITY": "90 tablet",
        "start_date": null,
        "end_date": null,
        "status": "Sent"
      },
      {
        "ORDER_MED_ID": 772179269,
        "medication": "Nortriptyline HCl Cap 10 MG\r",
        "dose": null,
        "REFILLS": 3,
        "QUANTITY": "180 capsule",
        "start_date": null,
        "end_date": null,
        "status": "Sent"
      },
      {
        "ORDER_MED_ID": 945468373,
        "medication": "Nortriptyline HCl Cap 10 MG\r",
        "dose": 30,
        "REFILLS": 3,
        "QUANTITY": "270 capsule",
        "start_date": null,
        "end_date": null,
        "status": "Sent"
      },
      {
        "ORDER_MED_ID": 772179266,
        "medication": "Nortriptyline HCl Cap 10 MG\r",
        "dose": 10,
        "REFILLS": 1,
        "QUANTITY": "90 capsule",
        "start_date": null,
        "end_date": null,
        "status": "Sent"
      }
    ],
    "columns": [
      "ORDER_MED_ID",
      "medication",
      "dose",
      "REFILLS",
      "QUANTITY",
      "start_date",
      "end_date",
      "status"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-4",
    "originalQuery": "SELECT \n  op.DESCRIPTION as test_name,\n  res.ORD_VALUE as result,\n  res.REFERENCE_UNIT as units,\n  res.REFERENCE_LOW,\n  res.REFERENCE_HIGH,\n  DATE(res.RESULT_DATE) as result_date,\n  CASE \n    WHEN CAST(res.ORD_VALUE AS REAL) < CAST(res.REFERENCE_LOW AS REAL) THEN 'Low'\n    WHEN CAST(res.ORD_VALUE AS REAL) > CAST(res.REFERENCE_HIGH AS REAL) THEN 'High'\n    ELSE 'Normal'\n  END as flag\nFROM ORDER_PROC op\nJOIN ORDER_RESULTS res ON op.ORDER_PROC_ID = res.ORDER_PROC_ID\nWHERE op.PAT_ID = 'Z7004242'\n  AND op.ORDER_TYPE_C_NAME = 'Lab'\n  AND res.ORD_VALUE IS NOT NULL\n  AND op.DESCRIPTION LIKE '%HEMOGLOBIN%'\nORDER BY res.RESULT_DATE DESC;",
    "description": "Trend lab results over time with reference ranges",
    "chapterId": "06.3-sql-recipe-library",
    "index": 4,
    "results": [
      {
        "test_name": "HEMOGLOBIN A1C",
        "result": "5.4",
        "units": "%",
        "REFERENCE_LOW": 4,
        "REFERENCE_HIGH": 6,
        "result_date": null,
        "flag": "Normal"
      },
      {
        "test_name": "HEMOGLOBIN A1C",
        "result": "108",
        "units": "mg/dL",
        "REFERENCE_LOW": null,
        "REFERENCE_HIGH": null,
        "result_date": null,
        "flag": "Normal"
      }
    ],
    "columns": [
      "test_name",
      "result",
      "units",
      "REFERENCE_LOW",
      "REFERENCE_HIGH",
      "result_date",
      "flag"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-5",
    "originalQuery": "SELECT \n  pl.PROBLEM_LIST_ID,\n  pl.DESCRIPTION as problem_name,\n  edg.DX_NAME as diagnosis_name,\n  DATE(pl.NOTED_DATE) as onset_date,\n  CASE WHEN pl.RESOLVED_DATE IS NOT NULL THEN 'Resolved' ELSE 'Active' END as status,\n  DATE(pl.RESOLVED_DATE) as resolved_date\nFROM PROBLEM_LIST pl\nLEFT JOIN CLARITY_EDG edg ON pl.DX_ID = edg.DX_ID\nJOIN PAT_PROBLEM_LIST ppl ON pl.PROBLEM_LIST_ID = ppl.PROBLEM_LIST_ID_\nWHERE ppl.PAT_ID = 'Z7004242'\n  AND pl.RESOLVED_DATE IS NULL\nORDER BY pl.NOTED_DATE DESC;",
    "description": "Active problem list with ICD-10 codes",
    "chapterId": "06.3-sql-recipe-library",
    "index": 5,
    "results": [],
    "columns": [],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-6",
    "originalQuery": "SELECT \n  imm.IMMUNE_ID,\n  ci.NAME_ as vaccine_name,\n  DATE(imm.IMMUNE_DATE) as given_date,\n  imm.DOSE,\n  imm.IMMNZTN_DOSE_UNIT_C_NAME as dose_unit,\n  imm.ROUTE_C_NAME,\n  imm.SITE_C_NAME,\n  imm.LOT\nFROM IMMUNE imm\nJOIN CLARITY_IMMUNZATN ci ON imm.IMMUNZATN_ID = ci.IMMUNZATN_ID\nJOIN PAT_IMMUNIZATIONS pi ON imm.IMMUNE_ID = pi.IMMUNE_ID_\nWHERE pi.PAT_ID = 'Z7004242'\nORDER BY imm.IMMUNE_DATE DESC;",
    "description": "Immunization history with vaccine details",
    "chapterId": "06.3-sql-recipe-library",
    "index": 6,
    "results": [
      {
        "IMMUNE_ID": 104512005,
        "vaccine_name": "INFLUENZA (FLUARIX) IIV4\r",
        "given_date": null,
        "DOSE": "0.5 mL",
        "dose_unit": "mL",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Deltoid",
        "LOT": "5ME77"
      },
      {
        "IMMUNE_ID": 91906111,
        "vaccine_name": "COVID-19 (PFIZER-BIVALENT) MRNA AGES 12+\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 82049279,
        "vaccine_name": "COVID-19 (MODERNA) MRNA\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 82049278,
        "vaccine_name": "COVID-19 (MODERNA) MRNA\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Right Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 59265744,
        "vaccine_name": "TYPHOID INACTIVATED (TYPHIM VI)\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 59265745,
        "vaccine_name": "TDAP\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 59265747,
        "vaccine_name": "HEPATITIS A (HAVRIX) HEPA ADULT\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Right Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 82049323,
        "vaccine_name": "COVID-19 (MODERNA) MRNA\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Deltoid",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 59265746,
        "vaccine_name": "INFLUENZA (FLUCELVAX) CCIIV4, PREFILLED SYRINGE\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Right Deltoid",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 59265748,
        "vaccine_name": "INFLUENZA, UNSPECIFIED FORMULATION\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 90573906,
        "vaccine_name": "INFLUENZA, INACTIVATED, QUADRIVALENT, ALL AGES 6 MONTHS AND OLDER, SINGLE DOSE SYRINGE/VIAL\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 94544282,
        "vaccine_name": "INFLUENZA, INACTIVATED, QUADRIVALENT, ALL AGES 6 MONTHS AND OLDER, SINGLE DOSE SYRINGE/VIAL\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Deltoid",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 30666377,
        "vaccine_name": "INFLUENZA (FLUCELVAX) CCIIV4, PREFILLED SYRINGE\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      },
      {
        "IMMUNE_ID": 90573907,
        "vaccine_name": "INFLUENZA, INACTIVATED, QUADRIVALENT, ALL AGES 6 MONTHS AND OLDER, SINGLE DOSE SYRINGE/VIAL\r",
        "given_date": null,
        "DOSE": "",
        "dose_unit": "",
        "ROUTE_C_NAME": "Intramuscular",
        "SITE_C_NAME": "Left Arm",
        "LOT": ""
      }
    ],
    "columns": [
      "IMMUNE_ID",
      "vaccine_name",
      "given_date",
      "DOSE",
      "dose_unit",
      "ROUTE_C_NAME",
      "SITE_C_NAME",
      "LOT"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-7",
    "originalQuery": "SELECT \n  ha.HSP_ACCOUNT_ID,\n  ha.ACCT_BILLSTS_HA_C_NAME as billing_status,\n  -- Calculate totals from transactions\n  (SELECT SUM(TX_AMOUNT) FROM HSP_TRANSACTIONS ht \n   WHERE ht.HSP_ACCOUNT_ID = ha.HSP_ACCOUNT_ID \n   AND ht.TX_TYPE_HA_C_NAME = 'Charge') as total_charges,\n  (SELECT SUM(TX_AMOUNT) FROM HSP_TRANSACTIONS ht \n   WHERE ht.HSP_ACCOUNT_ID = ha.HSP_ACCOUNT_ID \n   AND ht.TX_TYPE_HA_C_NAME = 'Payment') as total_payments,\n  DATE(ha.ADM_DATE_TIME) as admit_date,\n  DATE(ha.DISCH_DATE_TIME) as discharge_date\nFROM HSP_ACCOUNT ha\nWHERE ha.HSP_ACCOUNT_ID IN (\n  SELECT DISTINCT HSP_ACCOUNT_ID \n  FROM PAT_ENC \n  WHERE PAT_ID = 'Z7004242' \n  AND HSP_ACCOUNT_ID IS NOT NULL\n)\nORDER BY ha.ADM_DATE_TIME DESC;",
    "description": "Hospital account balances and coverage",
    "chapterId": "06.3-sql-recipe-library",
    "index": 7,
    "results": [
      {
        "HSP_ACCOUNT_ID": 376684810,
        "billing_status": "Closed",
        "total_charges": 1638.8200000000002,
        "total_payments": -676,
        "admit_date": null,
        "discharge_date": null
      }
    ],
    "columns": [
      "HSP_ACCOUNT_ID",
      "billing_status",
      "total_charges",
      "total_payments",
      "admit_date",
      "discharge_date"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-8",
    "originalQuery": "SELECT \n  ht.TX_ID,\n  ht.HSP_ACCOUNT_ID,\n  DATE(ht.SERVICE_DATE) as service_date,\n  DATE(ht.TX_POST_DATE) as post_date,\n  ht.TX_TYPE_HA_C_NAME as transaction_type,\n  ht.TX_AMOUNT as amount,\n  ht.BUCKET_ID,\n  ht.FIN_CLASS_C_NAME\nFROM HSP_TRANSACTIONS ht\nWHERE ht.HSP_ACCOUNT_ID IN (\n  SELECT DISTINCT HSP_ACCOUNT_ID \n  FROM PAT_ENC \n  WHERE PAT_ID = 'Z7004242' \n  AND HSP_ACCOUNT_ID IS NOT NULL\n)\nORDER BY ht.TX_POST_DATE DESC, ht.TX_ID;",
    "description": "Hospital transactions by type and bucket",
    "chapterId": "06.3-sql-recipe-library",
    "index": 8,
    "results": [
      {
        "TX_ID": 685171641,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Payment",
        "amount": -554.27,
        "BUCKET_ID": 464353000,
        "FIN_CLASS_C_NAME": "Self-Pay"
      },
      {
        "TX_ID": 681354876,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Payment",
        "amount": -121.73,
        "BUCKET_ID": 464353002,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 681354878,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Credit Adjustment",
        "amount": -962.82,
        "BUCKET_ID": 464353002,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 681354880,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Debit Adjustment",
        "amount": 554.27,
        "BUCKET_ID": 464353000,
        "FIN_CLASS_C_NAME": "Self-Pay"
      },
      {
        "TX_ID": 681354883,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Credit Adjustment",
        "amount": -554.27,
        "BUCKET_ID": 464353002,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 678816450,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Credit Adjustment",
        "amount": -1638.82,
        "BUCKET_ID": 464352999,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 678816451,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Debit Adjustment",
        "amount": 1638.82,
        "BUCKET_ID": 464353002,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 672984063,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Charge",
        "amount": 865.08,
        "BUCKET_ID": null,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 670514271,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Charge",
        "amount": 216.27,
        "BUCKET_ID": null,
        "FIN_CLASS_C_NAME": "Blue Cross"
      },
      {
        "TX_ID": 670514272,
        "HSP_ACCOUNT_ID": 376684810,
        "service_date": null,
        "post_date": null,
        "transaction_type": "Charge",
        "amount": 557.47,
        "BUCKET_ID": null,
        "FIN_CLASS_C_NAME": "Blue Cross"
      }
    ],
    "columns": [
      "TX_ID",
      "HSP_ACCOUNT_ID",
      "service_date",
      "post_date",
      "transaction_type",
      "amount",
      "BUCKET_ID",
      "FIN_CLASS_C_NAME"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-9",
    "originalQuery": "SELECT \n  at.TX_ID,\n  at.ACCOUNT_ID,\n  DATE(at.SERVICE_DATE) as service_date,\n  DATE(at.POST_DATE) as post_date,\n  eap.PROC_NAME_ as procedure_name,\n  at.PROC_ID,\n  at.TX_TYPE_C_NAME,\n  at.AMOUNT,\n  at.BILLING_PROV_ID\nFROM ARPB_TRANSACTIONS at\nLEFT JOIN CLARITY_EAP eap ON at.PROC_ID = eap.PROC_ID\nWHERE at.ACCOUNT_ID IN (\n  SELECT DISTINCT ACCOUNT_ID \n  FROM PAT_ENC \n  WHERE PAT_ID = 'Z7004242' \n  AND ACCOUNT_ID IS NOT NULL\n)\n  AND at.VOID_DATE IS NULL\nORDER BY at.SERVICE_DATE DESC, at.TX_ID;",
    "description": "Professional billing transactions by visit",
    "chapterId": "06.3-sql-recipe-library",
    "index": 9,
    "results": [],
    "columns": [],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-10",
    "originalQuery": "WITH completeness_check AS (\n  SELECT \n    'PAT_ENC' as table_name,\n    COUNT(*) as total_rows,\n    SUM(CASE WHEN CONTACT_DATE IS NULL THEN 1 ELSE 0 END) as null_dates,\n    SUM(CASE WHEN DEPARTMENT_ID IS NULL THEN 1 ELSE 0 END) as null_dept,\n    SUM(CASE WHEN VISIT_PROV_ID IS NULL THEN 1 ELSE 0 END) as null_provider\n  FROM PAT_ENC\n  WHERE PAT_ID = 'Z7004242'\n  \n  UNION ALL\n  \n  SELECT \n    'PAT_ENC_DX',\n    COUNT(*),\n    SUM(CASE WHEN CONTACT_DATE IS NULL THEN 1 ELSE 0 END),\n    SUM(CASE WHEN DX_ID IS NULL THEN 1 ELSE 0 END),\n    0\n  FROM PAT_ENC_DX\n  WHERE PAT_ENC_CSN_ID IN (SELECT PAT_ENC_CSN_ID FROM PAT_ENC WHERE PAT_ID = 'Z7004242')\n)\nSELECT \n  table_name,\n  total_rows,\n  null_dates,\n  null_dept,\n  null_provider,\n  ROUND(100.0 * (total_rows - null_dates - null_dept - null_provider) / total_rows, 1) as completeness_pct\nFROM completeness_check;",
    "description": "Check for data completeness across key tables",
    "chapterId": "06.3-sql-recipe-library",
    "index": 10,
    "results": [
      {
        "table_name": "PAT_ENC",
        "total_rows": 111,
        "null_dates": 0,
        "null_dept": 66,
        "null_provider": 66,
        "completeness_pct": -18.9
      },
      {
        "table_name": "PAT_ENC_DX",
        "total_rows": 32,
        "null_dates": 0,
        "null_dept": 0,
        "null_provider": 0,
        "completeness_pct": 100
      }
    ],
    "columns": [
      "table_name",
      "total_rows",
      "null_dates",
      "null_dept",
      "null_provider",
      "completeness_pct"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-11",
    "originalQuery": "-- Check for diagnoses without valid encounters\nSELECT \n  'Orphaned Diagnoses' as issue,\n  COUNT(*) as count\nFROM PAT_ENC_DX dx\nWHERE NOT EXISTS (\n  SELECT 1 FROM PAT_ENC pe \n  WHERE pe.PAT_ENC_CSN_ID = dx.PAT_ENC_CSN_ID\n)\n\nUNION ALL\n\n-- Check for orders without valid encounters\nSELECT \n  'Orphaned Orders',\n  COUNT(*)\nFROM ORDER_PROC op\nWHERE op.PAT_ENC_CSN_ID IS NOT NULL\n  AND NOT EXISTS (\n    SELECT 1 FROM PAT_ENC pe \n    WHERE pe.PAT_ENC_CSN_ID = op.PAT_ENC_CSN_ID\n  )\n\nUNION ALL\n\n-- Check for results without valid orders\nSELECT \n  'Orphaned Results',\n  COUNT(*)\nFROM ORDER_RESULTS res\nWHERE NOT EXISTS (\n  SELECT 1 FROM ORDER_PROC op \n  WHERE op.ORDER_PROC_ID = res.ORDER_PROC_ID\n);",
    "description": "Check for orphaned records and broken references",
    "chapterId": "06.3-sql-recipe-library",
    "index": 11,
    "results": [
      {
        "issue": "Orphaned Diagnoses",
        "count": 0
      },
      {
        "issue": "Orphaned Orders",
        "count": 0
      },
      {
        "issue": "Orphaned Results",
        "count": 0
      }
    ],
    "columns": [
      "issue",
      "count"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-12",
    "originalQuery": "WITH date_checks AS (\n  -- Medications with end date before start date\n  SELECT \n    'Medication dates reversed' as issue_type,\n    ORDER_MED_ID as record_id,\n    'ORDER_MED' as table_name\n  FROM ORDER_MED\n  WHERE END_DATE < START_DATE\n  \n  UNION ALL\n  \n  -- Results dated before order\n  SELECT \n    'Result before order',\n    res.ORDER_PROC_ID,\n    'ORDER_RESULTS'\n  FROM ORDER_RESULTS res\n  JOIN ORDER_PROC op ON res.ORDER_PROC_ID = op.ORDER_PROC_ID\n  WHERE res.RESULT_DATE < op.ORDERING_DATE\n  \n  UNION ALL\n  \n  -- Discharge before admission\n  SELECT \n    'Discharge before admission',\n    HSP_ACCOUNT_ID,\n    'HSP_ACCOUNT'\n  FROM HSP_ACCOUNT\n  WHERE DISCH_DATE_TIME < ADM_DATE_TIME\n    AND DISCH_DATE_TIME IS NOT NULL\n)\nSELECT \n  issue_type,\n  COUNT(*) as occurrence_count,\n  table_name\nFROM date_checks\nGROUP BY issue_type, table_name;",
    "description": "Find date inconsistencies in clinical workflows",
    "chapterId": "06.3-sql-recipe-library",
    "index": 12,
    "results": [
      {
        "issue_type": "Discharge before admission",
        "occurrence_count": 2,
        "table_name": "HSP_ACCOUNT"
      },
      {
        "issue_type": "Medication dates reversed",
        "occurrence_count": 2,
        "table_name": "ORDER_MED"
      }
    ],
    "columns": [
      "issue_type",
      "occurrence_count",
      "table_name"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-13",
    "originalQuery": "-- Good: Use indexed date columns directly\nSELECT COUNT(*) as encounters_last_year\nFROM PAT_ENC pe\nWHERE pe.CONTACT_DATE >= date('now', '-1 year')\n  AND pe.CONTACT_DATE < date('now')\n  AND pe.PAT_ID = 'Z7004242';",
    "description": "Efficient pattern for date range filtering",
    "chapterId": "06.3-sql-recipe-library",
    "index": 13,
    "results": [
      {
        "encounters_last_year": 0
      }
    ],
    "columns": [
      "encounters_last_year"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-14",
    "originalQuery": "-- Use CTEs to filter early and reduce join overhead\nWITH recent_encounters AS (\n  SELECT PAT_ENC_CSN_ID, CONTACT_DATE, DEPARTMENT_ID\n  FROM PAT_ENC\n  WHERE PAT_ID = 'Z7004242'\n    AND CONTACT_DATE >= date('now', '-6 months')\n),\nencounter_dx AS (\n  SELECT dx.PAT_ENC_CSN_ID, dx.DX_ID, dx.LINE\n  FROM PAT_ENC_DX dx\n  WHERE dx.PAT_ENC_CSN_ID IN (SELECT PAT_ENC_CSN_ID FROM recent_encounters)\n    AND dx.PRIMARY_DX_YN = 'Y'\n)\nSELECT \n  re.PAT_ENC_CSN_ID,\n  DATE(re.CONTACT_DATE) as visit_date,\n  dep.DEPARTMENT_NAME,\n  edg.DX_NAME as primary_diagnosis\nFROM recent_encounters re\nLEFT JOIN CLARITY_DEP dep ON re.DEPARTMENT_ID = dep.DEPARTMENT_ID\nLEFT JOIN encounter_dx dx ON re.PAT_ENC_CSN_ID = dx.PAT_ENC_CSN_ID\nLEFT JOIN CLARITY_EDG edg ON dx.DX_ID = edg.DX_ID\nORDER BY re.CONTACT_DATE DESC;",
    "description": "Efficient multi-table join using Epic patterns",
    "chapterId": "06.3-sql-recipe-library",
    "index": 14,
    "results": [
      {
        "PAT_ENC_CSN_ID": 837844366,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 1028739468,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1028766353,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 787137346,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1028606559,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1027863229,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 962603110,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 898794674,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 840888730,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 839256727,
        "visit_date": null,
        "DEPARTMENT_NAME": "GENERIC EXTERNAL DATA DEPARTMENT",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 724619887,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL BUSINESS SERVICES",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 724623985,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 724628999,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1018439080,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 958134730,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 958147754,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 957995289,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 727947624,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1022460205,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 957265560,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 893473416,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 836036457,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 781842097,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1020583168,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL LABORATORY",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 833901305,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 948002801,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 832464108,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1016759309,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 951207510,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 888227767,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 831452662,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 777174829,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 829995922,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829996120,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 830043848,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 830047706,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 829467718,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829212157,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 829385742,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 829393933,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829213099,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829273579,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 829282937,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 827277205,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1011533066,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 946189306,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 883637721,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 772693619,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1006342664,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 940919045,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 878774242,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 768007053,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 1000825434,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 935515793,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 873928397,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 763443168,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 996534320,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 995315871,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 930010268,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 869002878,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 758599939,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 922943112,
        "visit_date": null,
        "DEPARTMENT_NAME": "MHM OT NEURO CENTRAL",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 928532643,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 958148810,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 991215738,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 991221485,
        "visit_date": null,
        "DEPARTMENT_NAME": "MAC APL INTERNAL MEDICINE",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 922942674,
        "visit_date": null,
        "DEPARTMENT_NAME": "MHM OT NEURO CENTRAL",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 927098738,
        "visit_date": null,
        "DEPARTMENT_NAME": "GENERIC EXTERNAL DATA DEPARTMENT",
        "primary_diagnosis": null
      },
      {
        "PAT_ENC_CSN_ID": 927200229,
        "visit_date": null,
        "DEPARTMENT_NAME": null,
        "primary_diagnosis": null
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "visit_date",
      "DEPARTMENT_NAME",
      "primary_diagnosis"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-15",
    "originalQuery": "WITH last_visits AS (\n  -- Find most recent visit per patient\n  SELECT \n    PAT_ID,\n    MAX(CONTACT_DATE) as last_visit_date,\n    julianday('now') - julianday(MAX(CONTACT_DATE)) as days_since_visit\n  FROM PAT_ENC\n  GROUP BY PAT_ID\n),\nlast_labs AS (\n  -- Find most recent A1C for diabetic monitoring\n  SELECT \n    op.PAT_ID,\n    MAX(res.RESULT_DATE) as last_a1c_date,\n    julianday('now') - julianday(MAX(res.RESULT_DATE)) as days_since_a1c\n  FROM ORDER_PROC op\n  JOIN ORDER_RESULTS res ON op.ORDER_PROC_ID = res.ORDER_PROC_ID\n  WHERE op.DESCRIPTION LIKE '%A1C%'\n  GROUP BY op.PAT_ID\n)\nSELECT \n  p.PAT_ID,\n  p.PAT_NAME,\n  DATE(lv.last_visit_date) as last_visit,\n  lv.days_since_visit,\n  DATE(ll.last_a1c_date) as last_a1c,\n  ll.days_since_a1c,\n  CASE \n    WHEN ll.days_since_a1c > 180 OR ll.days_since_a1c IS NULL THEN 'Due for A1C'\n    WHEN lv.days_since_visit > 365 THEN 'Due for Annual Visit'\n    ELSE 'Up to Date'\n  END as care_status\nFROM PATIENT p\nLEFT JOIN last_visits lv ON p.PAT_ID = lv.PAT_ID\nLEFT JOIN last_labs ll ON p.PAT_ID = ll.PAT_ID\nWHERE p.CUR_PCP_PROV_ID IS NOT NULL;",
    "description": "Find patients due for health maintenance",
    "chapterId": "06.3-sql-recipe-library",
    "index": 15,
    "results": [
      {
        "PAT_ID": "Z7004242",
        "PAT_NAME": "MANDEL,JOSHUA C",
        "last_visit": null,
        "days_since_visit": null,
        "last_a1c": null,
        "days_since_a1c": null,
        "care_status": "Due for A1C"
      }
    ],
    "columns": [
      "PAT_ID",
      "PAT_NAME",
      "last_visit",
      "days_since_visit",
      "last_a1c",
      "days_since_a1c",
      "care_status"
    ],
    "error": null
  },
  {
    "id": "06.3-sql-recipe-library-16",
    "originalQuery": "WITH utilization_summary AS (\n  SELECT \n    pe.PAT_ID,\n    strftime('%Y', pe.CONTACT_DATE) as year,\n    dep.DEPARTMENT_NAME,\n    COUNT(*) as visit_count,\n    COUNT(DISTINCT DATE(pe.CONTACT_DATE)) as unique_days\n  FROM PAT_ENC pe\n  LEFT JOIN CLARITY_DEP dep ON pe.DEPARTMENT_ID = dep.DEPARTMENT_ID\n  WHERE pe.CONTACT_DATE >= date('now', '-2 years')\n  GROUP BY pe.PAT_ID, year, dep.DEPARTMENT_NAME\n)\nSELECT \n  PAT_ID,\n  year,\n  SUM(visit_count) as total_visits,\n  COUNT(DISTINCT DEPARTMENT_NAME) as departments_seen,\n  SUM(unique_days) as total_visit_days,\n  GROUP_CONCAT(DEPARTMENT_NAME || ' (' || visit_count || ')', ', ') as department_breakdown\nFROM utilization_summary\nGROUP BY PAT_ID, year\nORDER BY year DESC, total_visits DESC;",
    "description": "Patient utilization summary by encounter type",
    "chapterId": "06.3-sql-recipe-library",
    "index": 16,
    "results": [
      {
        "PAT_ID": "Z7004242",
        "year": null,
        "total_visits": 74,
        "departments_seen": 5,
        "total_visit_days": 0,
        "department_breakdown": "GENERIC EXTERNAL DATA DEPARTMENT (2), MAC APL BUSINESS SERVICES (1), MAC APL INTERNAL MEDICINE (24), MAC APL LABORATORY (4), MHM OT NEURO CENTRAL (2)"
      }
    ],
    "columns": [
      "PAT_ID",
      "year",
      "total_visits",
      "departments_seen",
      "total_visit_days",
      "department_breakdown"
    ],
    "error": null
  }
]