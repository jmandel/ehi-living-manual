[
  {
    "id": "02.3-the-id-line-paradigm-0",
    "originalQuery": "SELECT \n  ped.PAT_ENC_CSN_ID,\n  ped.LINE,\n  edg.DX_NAME,\n  ped.PRIMARY_DX_YN,\n  CASE \n    WHEN ped.LINE = 1 THEN 'Primary'\n    ELSE 'Secondary' \n  END as dx_type\nFROM PAT_ENC_DX ped\nLEFT JOIN CLARITY_EDG edg ON ped.DX_ID = edg.DX_ID\nWHERE ped.PAT_ENC_CSN_ID = 720803470\nORDER BY ped.LINE;",
    "description": "See how diagnoses use LINE numbers for a single encounter",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 0,
    "results": [
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 1,
        "DX_NAME": "Encounter to establish care",
        "PRIMARY_DX_YN": "Y",
        "dx_type": "Primary"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 2,
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "PRIMARY_DX_YN": "N",
        "dx_type": "Secondary"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 3,
        "DX_NAME": "Dyspepsia",
        "PRIMARY_DX_YN": "N",
        "dx_type": "Secondary"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "LINE",
      "DX_NAME",
      "PRIMARY_DX_YN",
      "dx_type"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-1",
    "originalQuery": "SELECT \n  PAT_ENC_CSN_ID,\n  GROUP_CONCAT(LINE, ', ') as line_numbers,\n  COUNT(*) as total_diagnoses\nFROM PAT_ENC_DX \nGROUP BY PAT_ENC_CSN_ID\nHAVING COUNT(*) >= 2\nORDER BY total_diagnoses DESC\nLIMIT 5;",
    "description": "Check LINE sequences across multiple encounters",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 1,
    "results": [
      {
        "PAT_ENC_CSN_ID": 991225117,
        "line_numbers": "1, 2, 3, 4",
        "total_diagnoses": 4
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "line_numbers": "1, 2, 3",
        "total_diagnoses": 3
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "line_numbers": "1, 2, 3",
        "total_diagnoses": 3
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "line_numbers": "1, 2, 3",
        "total_diagnoses": 3
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "line_numbers": "1, 2, 3",
        "total_diagnoses": 3
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "line_numbers",
      "total_diagnoses"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-2",
    "originalQuery": "SELECT \n  a.ALLERGY_ID,\n  ar.LINE,\n  ar.REACTION_C_NAME_ as reaction\nFROM ALLERGY a\nLEFT JOIN ALLERGY_REACTIONS ar ON a.ALLERGY_ID = ar.ALLERGY_ID\nWHERE a.ALLERGY_ID IN (30689238, 30689295)\nORDER BY a.ALLERGY_ID, ar.LINE;",
    "description": "See LINE pattern in allergy reactions",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 2,
    "results": [
      {
        "ALLERGY_ID": 30689238,
        "LINE": 1,
        "reaction": "Hives"
      },
      {
        "ALLERGY_ID": 30689295,
        "LINE": 1,
        "reaction": "Hives\r"
      }
    ],
    "columns": [
      "ALLERGY_ID",
      "LINE",
      "reaction"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-3",
    "originalQuery": "SELECT \n  ped.PAT_ENC_CSN_ID,\n  ped.LINE,\n  edg.DX_NAME,\n  ped.DX_CHRONIC_YN as is_chronic\nFROM PAT_ENC_DX ped\nJOIN CLARITY_EDG edg ON ped.DX_ID = edg.DX_ID\nWHERE ped.PAT_ENC_CSN_ID IN (\n  -- Find encounters with 3+ diagnoses\n  SELECT PAT_ENC_CSN_ID \n  FROM PAT_ENC_DX \n  GROUP BY PAT_ENC_CSN_ID \n  HAVING COUNT(*) >= 3\n)\nORDER BY ped.PAT_ENC_CSN_ID, ped.LINE\nLIMIT 10;",
    "description": "Retrieve all diagnoses for encounters with multiple conditions",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 3,
    "results": [
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 1,
        "DX_NAME": "Encounter to establish care",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 2,
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "LINE": 3,
        "DX_NAME": "Dyspepsia",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "LINE": 1,
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "LINE": 2,
        "DX_NAME": "Lipoma of head",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "LINE": 3,
        "DX_NAME": "Nevus",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "LINE": 1,
        "DX_NAME": "Primary hypertension",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "LINE": 2,
        "DX_NAME": "Preventative health care",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "LINE": 3,
        "DX_NAME": "Post concussion syndrome",
        "is_chronic": "N"
      },
      {
        "PAT_ENC_CSN_ID": 991225117,
        "LINE": 1,
        "DX_NAME": "Screening for hyperlipidemia",
        "is_chronic": "N"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "LINE",
      "DX_NAME",
      "is_chronic"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-4",
    "originalQuery": "SELECT \n  pe.PAT_ENC_CSN_ID,\n  pe.CONTACT_DATE,\n  edg.DX_NAME as primary_diagnosis\nFROM PAT_ENC pe\nLEFT JOIN PAT_ENC_DX ped \n  ON pe.PAT_ENC_CSN_ID = ped.PAT_ENC_CSN_ID \n  AND ped.LINE = 1  -- Primary diagnosis only\nLEFT JOIN CLARITY_EDG edg \n  ON ped.DX_ID = edg.DX_ID\nWHERE pe.CONTACT_DATE >= '2018-01-01'\n  AND edg.DX_NAME IS NOT NULL\nORDER BY pe.CONTACT_DATE DESC\nLIMIT 10;",
    "description": "Get only primary diagnoses across all encounters",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 4,
    "results": [
      {
        "PAT_ENC_CSN_ID": 991225117,
        "CONTACT_DATE": "9/28/2023 12:00:00 AM",
        "primary_diagnosis": "Screening for hyperlipidemia"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "CONTACT_DATE": "9/28/2023 12:00:00 AM",
        "primary_diagnosis": "Screening for diabetes mellitus"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "CONTACT_DATE": "8/9/2018 12:00:00 AM",
        "primary_diagnosis": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 724628999,
        "CONTACT_DATE": "8/9/2018 12:00:00 AM",
        "primary_diagnosis": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "CONTACT_DATE": "8/29/2022 12:00:00 AM",
        "primary_diagnosis": "Primary hypertension"
      },
      {
        "PAT_ENC_CSN_ID": 958147754,
        "CONTACT_DATE": "8/29/2022 12:00:00 AM",
        "primary_diagnosis": "Primary hypertension"
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "CONTACT_DATE": "8/18/2018 12:00:00 AM",
        "primary_diagnosis": "Gastroesophageal reflux disease, esophagitis presence not specified"
      },
      {
        "PAT_ENC_CSN_ID": 832464108,
        "CONTACT_DATE": "7/31/2020 12:00:00 AM",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829995922,
        "CONTACT_DATE": "7/21/2020 12:00:00 AM",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      },
      {
        "PAT_ENC_CSN_ID": 829467718,
        "CONTACT_DATE": "7/16/2020 12:00:00 AM",
        "primary_diagnosis": "Traumatic injury of head, initial encounter"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "CONTACT_DATE",
      "primary_diagnosis"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-5",
    "originalQuery": "SELECT \n  PAT_ENC_CSN_ID,\n  COUNT(*) as total_dx,\n  MAX(CASE WHEN LINE = 1 THEN dx_name END) as primary_dx,\n  MAX(CASE WHEN LINE = 2 THEN dx_name END) as secondary_dx,\n  MAX(CASE WHEN LINE = 3 THEN dx_name END) as tertiary_dx\nFROM (\n  SELECT ped.PAT_ENC_CSN_ID, ped.LINE, edg.DX_NAME as dx_name\n  FROM PAT_ENC_DX ped\n  LEFT JOIN CLARITY_EDG edg ON ped.DX_ID = edg.DX_ID\n  WHERE edg.DX_NAME IS NOT NULL\n)\nGROUP BY PAT_ENC_CSN_ID\nHAVING COUNT(*) >= 2\nORDER BY total_dx DESC\nLIMIT 10;",
    "description": "Show first three diagnoses as columns",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 5,
    "results": [
      {
        "PAT_ENC_CSN_ID": 991225117,
        "total_dx": 4,
        "primary_dx": "Screening for hyperlipidemia",
        "secondary_dx": "Screening for diabetes mellitus",
        "tertiary_dx": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "total_dx": 3,
        "primary_dx": "Screening for diabetes mellitus",
        "secondary_dx": "Screening for hyperlipidemia",
        "tertiary_dx": "Preventative health care"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "total_dx": 3,
        "primary_dx": "Primary hypertension",
        "secondary_dx": "Preventative health care",
        "tertiary_dx": "Post concussion syndrome"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "total_dx": 3,
        "primary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "secondary_dx": "Lipoma of head",
        "tertiary_dx": "Nevus"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "total_dx": 3,
        "primary_dx": "Encounter to establish care",
        "secondary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "tertiary_dx": "Dyspepsia"
      },
      {
        "PAT_ENC_CSN_ID": 829393933,
        "total_dx": 2,
        "primary_dx": "Traumatic injury of head, initial encounter",
        "secondary_dx": "Post-concussion headache",
        "tertiary_dx": null
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "total_dx": 2,
        "primary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "secondary_dx": "Dyspepsia",
        "tertiary_dx": null
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "total_dx",
      "primary_dx",
      "secondary_dx",
      "tertiary_dx"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-6",
    "originalQuery": "SELECT \n  edg.DX_NAME,\n  COUNT(DISTINCT ped.PAT_ENC_CSN_ID) as encounter_count,\n  COUNT(*) as total_occurrences,\n  SUM(CASE WHEN ped.LINE = 1 THEN 1 ELSE 0 END) as times_primary,\n  ROUND(\n    100.0 * SUM(CASE WHEN ped.LINE = 1 THEN 1 ELSE 0 END) / COUNT(*), \n    1\n  ) as pct_primary\nFROM PAT_ENC_DX ped\nJOIN CLARITY_EDG edg ON ped.DX_ID = edg.DX_ID\nGROUP BY edg.DX_NAME\nHAVING COUNT(*) >= 3\nORDER BY encounter_count DESC\nLIMIT 10;",
    "description": "Count diagnosis frequency across all encounters",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 6,
    "results": [
      {
        "DX_NAME": "Post concussion syndrome",
        "encounter_count": 7,
        "total_occurrences": 7,
        "times_primary": 5,
        "pct_primary": 71.4
      },
      {
        "DX_NAME": "Traumatic injury of head, initial encounter",
        "encounter_count": 5,
        "total_occurrences": 5,
        "times_primary": 5,
        "pct_primary": 100
      },
      {
        "DX_NAME": "Preventative health care",
        "encounter_count": 3,
        "total_occurrences": 3,
        "times_primary": 0,
        "pct_primary": 0
      },
      {
        "DX_NAME": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "encounter_count": 3,
        "total_occurrences": 3,
        "times_primary": 2,
        "pct_primary": 66.7
      }
    ],
    "columns": [
      "DX_NAME",
      "encounter_count",
      "total_occurrences",
      "times_primary",
      "pct_primary"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-7",
    "originalQuery": "-- This query duplicates encounters for each diagnosis\nSELECT COUNT(*) as apparent_encounters\nFROM PAT_ENC pe\nJOIN PAT_ENC_DX ped ON pe.PAT_ENC_CSN_ID = ped.PAT_ENC_CSN_ID\nWHERE pe.CONTACT_DATE >= '2020-01-01';",
    "description": "WRONG - Creates duplicate encounter rows",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 7,
    "results": [
      {
        "apparent_encounters": 24
      }
    ],
    "columns": [
      "apparent_encounters"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-8",
    "originalQuery": "-- This properly counts distinct encounters\nSELECT COUNT(DISTINCT pe.PAT_ENC_CSN_ID) as actual_encounters\nFROM PAT_ENC pe\nJOIN PAT_ENC_DX ped ON pe.PAT_ENC_CSN_ID = ped.PAT_ENC_CSN_ID\nWHERE pe.CONTACT_DATE >= '2020-01-01';",
    "description": "CORRECT - Counts unique encounters",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 8,
    "results": [
      {
        "actual_encounters": 13
      }
    ],
    "columns": [
      "actual_encounters"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-9",
    "originalQuery": "SELECT \n  dx1.PAT_ENC_CSN_ID,\n  edg1.DX_NAME as primary_dx,\n  edg2.DX_NAME as secondary_dx  -- May be NULL\nFROM PAT_ENC_DX dx1\nJOIN CLARITY_EDG edg1 ON dx1.DX_ID = edg1.DX_ID\nLEFT JOIN PAT_ENC_DX dx2 \n  ON dx1.PAT_ENC_CSN_ID = dx2.PAT_ENC_CSN_ID \n  AND dx2.LINE = 2\nLEFT JOIN CLARITY_EDG edg2 ON dx2.DX_ID = edg2.DX_ID\nWHERE dx1.LINE = 1\n  AND dx1.PAT_ENC_CSN_ID IN (720803470, 725327197, 799951565)\nORDER BY dx1.PAT_ENC_CSN_ID;",
    "description": "Handle potentially missing secondary diagnoses",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 9,
    "results": [
      {
        "PAT_ENC_CSN_ID": 720803470,
        "primary_dx": "Encounter to establish care",
        "secondary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified"
      },
      {
        "PAT_ENC_CSN_ID": 725327197,
        "primary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "secondary_dx": "Dyspepsia"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "primary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified",
        "secondary_dx": "Lipoma of head"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "primary_dx",
      "secondary_dx"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-10",
    "originalQuery": "-- Pre-aggregate diagnosis counts\nWITH dx_summary AS (\n  SELECT \n    PAT_ENC_CSN_ID,\n    COUNT(*) as dx_count,\n    MAX(CASE WHEN ped.LINE = 1 THEN edg.DX_NAME END) as primary_dx\n  FROM PAT_ENC_DX ped\n  JOIN CLARITY_EDG edg ON ped.DX_ID = edg.DX_ID\n  GROUP BY PAT_ENC_CSN_ID\n)\nSELECT \n  pe.PAT_ENC_CSN_ID,\n  pe.CONTACT_DATE,\n  ds.dx_count,\n  ds.primary_dx\nFROM PAT_ENC pe\nJOIN dx_summary ds ON pe.PAT_ENC_CSN_ID = ds.PAT_ENC_CSN_ID\nWHERE ds.dx_count >= 3\nORDER BY pe.CONTACT_DATE DESC\nLIMIT 10;",
    "description": "Efficient aggregation before joining",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 10,
    "results": [
      {
        "PAT_ENC_CSN_ID": 991225117,
        "CONTACT_DATE": "9/28/2023 12:00:00 AM",
        "dx_count": 4,
        "primary_dx": "Screening for hyperlipidemia"
      },
      {
        "PAT_ENC_CSN_ID": 1028743701,
        "CONTACT_DATE": "9/28/2023 12:00:00 AM",
        "dx_count": 3,
        "primary_dx": "Screening for diabetes mellitus"
      },
      {
        "PAT_ENC_CSN_ID": 720803470,
        "CONTACT_DATE": "8/9/2018 12:00:00 AM",
        "dx_count": 3,
        "primary_dx": "Encounter to establish care"
      },
      {
        "PAT_ENC_CSN_ID": 948004323,
        "CONTACT_DATE": "8/29/2022 12:00:00 AM",
        "dx_count": 3,
        "primary_dx": "Primary hypertension"
      },
      {
        "PAT_ENC_CSN_ID": 799951565,
        "CONTACT_DATE": "1/9/2020 12:00:00 AM",
        "dx_count": 3,
        "primary_dx": "Gastroesophageal reflux disease, esophagitis presence not specified"
      }
    ],
    "columns": [
      "PAT_ENC_CSN_ID",
      "CONTACT_DATE",
      "dx_count",
      "primary_dx"
    ],
    "error": null
  },
  {
    "id": "02.3-the-id-line-paradigm-11",
    "originalQuery": "SELECT \n  cm.COVERAGE_ID,\n  cm.LINE,\n  cm.PAT_ID,\n  cm.MEM_COVERED_YN as is_active,\n  cov.CVG_EFF_DT as EFF_FROM_DATE,\n  cov.CVG_TERM_DT as EFF_TO_DATE\nFROM COVERAGE cov\nJOIN COVERAGE_MEMBER_LIST cm \n  ON cov.COVERAGE_ID = cm.COVERAGE_ID \nWHERE cm.PAT_ID = 'Z1489173'\nORDER BY cov.CVG_EFF_DT, cm.LINE;",
    "description": "Track insurance coverage periods using LINE",
    "chapterId": "02.3-the-id-line-paradigm",
    "index": 11,
    "results": [],
    "columns": [],
    "error": null
  }
]