# Chapter 6.2: Quick Cards

*Purpose: Ready-to-use SQL queries organized by common tasks, designed for quick copy-paste solutions to everyday Epic EHI data challenges.*

### The Most Important Query You'll Run

Before anything else, understand your data scope:

<example-query description="Check data date range and patient count">
SELECT 
  COUNT(DISTINCT PAT_ID) as total_patients,
  MIN(CONTACT_DATE) as earliest_encounter,
  MAX(CONTACT_DATE) as latest_encounter,
  COUNT(DISTINCT PAT_ENC_CSN_ID) as total_encounters
FROM PAT_ENC;
</example-query>

---

### Card 1: Find a Patient's Complete History

Start with the patient, then branch out to their clinical story.

<example-query description="Patient demographics and encounter summary">
SELECT 
  p.PAT_ID,
  p.PAT_MRN_ID as MRN,
  p.PAT_NAME,
  p.BIRTH_DATE,
  COUNT(DISTINCT pe.PAT_ENC_CSN_ID) as total_encounters,
  MIN(pe.CONTACT_DATE) as first_visit,
  MAX(pe.CONTACT_DATE) as last_visit
FROM PATIENT p
LEFT JOIN PAT_ENC pe ON p.PAT_ID = pe.PAT_ID
WHERE p.PAT_ID = 'Z7004242'  -- Replace with actual patient ID
GROUP BY p.PAT_ID, p.PAT_MRN_ID, p.PAT_NAME, p.BIRTH_DATE;
</example-query>

<example-query description="Recent encounters with department and provider">
SELECT 
  pe.PAT_ENC_CSN_ID as CSN,
  pe.CONTACT_DATE,
  dep.DEPARTMENT_NAME,
  ser.PROV_NAME as visit_provider
FROM PAT_ENC pe
LEFT JOIN CLARITY_DEP dep ON pe.DEPARTMENT_ID = dep.DEPARTMENT_ID
LEFT JOIN CLARITY_SER ser ON pe.VISIT_PROV_ID = ser.PROV_ID
WHERE pe.PAT_ID = 'Z7004242'
ORDER BY pe.CONTACT_DATE DESC
LIMIT 10;
</example-query>

---

### Card 2: Encounter Diagnoses

The **LINE** pattern is everywhere in Epic. Diagnoses use it to maintain order.

<example-query description="All diagnoses for a specific encounter">
SELECT 
  dx.LINE,
  dx.PRIMARY_DX_YN,
  edg.DX_NAME,
  edg.DX_ID as dx_code  -- Note: ICD codes not directly in CLARITY_EDG
FROM PAT_ENC_DX dx
JOIN CLARITY_EDG edg ON dx.DX_ID = edg.DX_ID
WHERE dx.PAT_ENC_CSN_ID = 720803470  -- Replace with actual CSN
ORDER BY dx.LINE;
</example-query>

<example-query description="Primary diagnoses across all encounters">
SELECT 
  pe.CONTACT_DATE,
  pe.PAT_ENC_CSN_ID,
  edg.DX_NAME,
  edg.DX_ID as dx_code  -- Note: ICD codes not directly in CLARITY_EDG
FROM PAT_ENC pe
JOIN PAT_ENC_DX dx ON pe.PAT_ENC_CSN_ID = dx.PAT_ENC_CSN_ID
JOIN CLARITY_EDG edg ON dx.DX_ID = edg.DX_ID
WHERE pe.PAT_ID = 'Z7004242'
  AND dx.PRIMARY_DX_YN = 'Y'
ORDER BY pe.CONTACT_DATE DESC;
</example-query>

---

### Card 3: Hospital Account Tracking

Hospital billing uses **HAR** (Hospital Account Record) as the financial container.

<example-query description="Find hospital accounts for a patient">
SELECT 
  ha.HSP_ACCOUNT_ID as HAR,
  ha.ACCT_BILLSTS_HA_C_NAME as billing_status,
  ha.TOT_CHGS as total_charges,
  ha.TOT_ADJ as total_adjustments,
  ha.TOT_CHGS - ha.TOT_ADJ as current_balance  -- Calculated balance
FROM PAT_ENC pe
JOIN HSP_ACCOUNT ha ON pe.HSP_ACCOUNT_ID = ha.HSP_ACCOUNT_ID
WHERE pe.PAT_ID = 'Z7004242'
ORDER BY ha.HSP_ACCOUNT_ID DESC;
</example-query>

<example-query description="Link encounters to their financial accounts">
SELECT 
  pe.PAT_ENC_CSN_ID,
  pe.CONTACT_DATE,
  pe.HSP_ACCOUNT_ID,
  ha.ACCT_BILLSTS_HA_C_NAME as billing_status,
  ha.TOT_CHGS - ha.TOT_ADJ as current_balance
FROM PAT_ENC pe
LEFT JOIN HSP_ACCOUNT ha ON pe.HSP_ACCOUNT_ID = ha.HSP_ACCOUNT_ID
WHERE pe.PAT_ID = 'Z7004242'
  AND pe.HSP_ACCOUNT_ID IS NOT NULL
ORDER BY pe.CONTACT_DATE DESC;
</example-query>

---

### Card 4: Provider Patterns

Remember: In Epic, a "provider" isn't just a doctor. It can be a department, equipment, or external entity.

<example-query description="Provider types in your system">
SELECT 
  'Provider' as provider_type,  -- Type not in basic CLARITY_SER
  COUNT(*) as count
FROM CLARITY_SER
WHERE PROV_ID IS NOT NULL
GROUP BY 1
ORDER BY count DESC;
</example-query>

<example-query description="Find all encounters for a specific provider">
SELECT 
  pe.PAT_ENC_CSN_ID,
  pe.CONTACT_DATE,
  p.PAT_NAME,
  dep.DEPARTMENT_NAME
FROM PAT_ENC pe
JOIN PATIENT p ON pe.PAT_ID = p.PAT_ID
LEFT JOIN CLARITY_DEP dep ON pe.DEPARTMENT_ID = dep.DEPARTMENT_ID
WHERE pe.VISIT_PROV_ID = 144590  -- Replace with provider ID
ORDER BY pe.CONTACT_DATE DESC
LIMIT 20;
</example-query>

---

### Card 5: Order Tracking

Orders link clinical intent to action (and often to charges).

<example-query description="Recent orders for a patient">
SELECT 
  op.ORDER_PROC_ID,
  op.ORDER_TIME,
  op.DESCRIPTION as order_description,
  op.ORDER_STATUS_C_NAME as order_status,
  ser.PROV_NAME as ordering_provider
FROM ORDER_PROC op
LEFT JOIN CLARITY_SER ser ON op.AUTHRZING_PROV_ID = ser.PROV_ID
WHERE op.PAT_ID = 'Z7004242'
ORDER BY op.ORDER_TIME DESC
LIMIT 20;
</example-query>

<example-query description="Orders for a specific encounter">
SELECT 
  op.ORDER_PROC_ID,
  op.DESCRIPTION,
  op.ORDER_STATUS_C_NAME as order_status,
  op.PROC_ID
FROM ORDER_PROC op
WHERE op.PAT_ENC_CSN_ID = 720803470  -- Replace with CSN
ORDER BY op.ORDER_TIME;
</example-query>

---

### Card 6: Lab Results Pattern

Lab results demonstrate Epic's multi-level data model: Order → Result → Components.

<example-query description="Lab results with component values">
SELECT 
  op.ORDER_PROC_ID,
  op.DESCRIPTION as lab_order,
  res.COMPONENT_ID,
  comp.NAME_ as component_name,
  res.ORD_NUM_VALUE,
  res.REFERENCE_UNIT,
  res.RESULT_DATE
FROM ORDER_PROC op
JOIN ORDER_RESULTS res ON op.ORDER_PROC_ID = res.ORDER_PROC_ID
JOIN CLARITY_COMPONENT comp ON res.COMPONENT_ID = comp.COMPONENT_ID
WHERE op.PAT_ID = 'Z7004242'
  AND op.ORDER_TYPE_C_NAME LIKE '%Lab%'  -- Lab orders
  AND res.ORD_NUM_VALUE IS NOT NULL
ORDER BY res.RESULT_DATE DESC
LIMIT 20;
</example-query>

---

### Card 7: Medication History

Medications involve multiple tables tracking orders, administration, and reconciliation.

<example-query description="Current medication orders">
SELECT 
  om.ORDER_MED_ID,
  om.START_DATE,
  om.END_DATE,
  med.GENERIC_NAME_ as medication_name,
  om.HV_DISCRETE_DOSE || ' ' || om.HV_DOSE_UNIT_C_NAME || ' ' || om.HV_DISCR_FREQ_ID_FREQ_NAME as sig_info,  -- Constructed sig
  om.QUANTITY,
  ser.PROV_NAME as prescriber
FROM ORDER_MED om
JOIN CLARITY_MEDICATION med ON om.MEDICATION_ID = med.MEDICATION_ID
LEFT JOIN CLARITY_SER ser ON om.AUTHRZING_PROV_ID = ser.PROV_ID
WHERE om.PAT_ID = 'Z7004242'
  AND om.ORDER_STATUS_C_NAME = 'Active'
ORDER BY om.START_DATE DESC;
</example-query>

---

### Card 8: Insurance Coverage

Coverage uses the **filing order** pattern: 1=Primary, 2=Secondary, etc.

<example-query description="Active insurance coverage">
SELECT 
  c.COVERAGE_ID,
  pcf.FILING_ORDER,
  epm.PAYOR_NAME_,
  epp.BENEFIT_PLAN_NAME_ as plan_name,
  cml.MEM_NUMBER as member_id,
  c.CVG_EFF_DT as eff_date,
  c.CVG_TERM_DT as term_date
FROM COVERAGE_MEMBER_LIST cml
JOIN COVERAGE c ON cml.COVERAGE_ID = c.COVERAGE_ID
LEFT JOIN PAT_CVG_FILE_ORDER pcf ON cml.PAT_ID = pcf.PAT_ID AND c.COVERAGE_ID = pcf.COVERAGE_ID
JOIN CLARITY_EPM epm ON c.PAYOR_ID = epm.PAYOR_ID
JOIN CLARITY_EPP epp ON c.PLAN_ID = epp.BENEFIT_PLAN_ID
WHERE cml.PAT_ID = 'Z7004242'
  AND (c.CVG_TERM_DT IS NULL OR c.CVG_TERM_DT > date('now'))
ORDER BY pcf.FILING_ORDER;
</example-query>

---

### Card 9: ADT (Admission/Discharge/Transfer) Events

ADT events track every patient movement through the facility.

<example-query description="Patient movement history">
SELECT 
  adt.EFFECTIVE_TIME,
  adt.EVENT_TYPE_C_NAME as event_type,
  dep.DEPARTMENT_NAME as location,
  adt.ROOM_ID,
  adt.BED_ID
FROM CLARITY_ADT adt
LEFT JOIN CLARITY_DEP dep ON adt.DEPARTMENT_ID = dep.DEPARTMENT_ID
WHERE adt.PAT_ENC_CSN_ID = 720803470  -- Replace with CSN
ORDER BY adt.EFFECTIVE_TIME;
</example-query>

---

### Card 10: Data Quality Checks

Trust, but verify. These queries help identify data issues.

<example-query description="Encounters without departments">
SELECT 
  COUNT(*) as encounters_missing_dept
FROM PAT_ENC
WHERE DEPARTMENT_ID IS NULL
  AND CONTACT_DATE > date('now', '-1 year');
</example-query>

<example-query description="Orders without associated encounters">
SELECT 
  COUNT(*) as orphaned_orders
FROM ORDER_PROC op
LEFT JOIN PAT_ENC pe ON op.PAT_ENC_CSN_ID = pe.PAT_ENC_CSN_ID
WHERE pe.PAT_ENC_CSN_ID IS NULL
  AND op.PAT_ENC_CSN_ID IS NOT NULL;
</example-query>

<example-query description="Check for duplicate patient records">
SELECT 
  PAT_NAME,
  BIRTH_DATE,
  COUNT(*) as duplicate_count
FROM PATIENT
GROUP BY PAT_NAME, BIRTH_DATE
HAVING COUNT(*) > 1;
</example-query>

---

### Common Query Patterns

#### Pattern 1: The LINE Join
```sql
-- When joining tables with LINE composite keys
SELECT * 
FROM parent_table p
JOIN child_table c ON p.ID = c.ID AND p.LINE = c.LINE;
```

#### Pattern 2: Latest Record
```sql
-- Get the most recent record using Epic date fields
SELECT * FROM table
WHERE PAT_ID = ?
ORDER BY CONTACT_DATE DESC
LIMIT 1;
```

#### Pattern 3: Active/Current Records
```sql
-- Many Epic tables use effective/term dates
SELECT * FROM coverage
WHERE PAT_ID = ?
  AND EFF_DATE <= date('now')
  AND (TERM_DATE IS NULL OR TERM_DATE > date('now'));
```

#### Pattern 4: Handling Nulls
```sql
-- Epic uses both NULL and empty strings
SELECT * FROM table
WHERE field IS NOT NULL 
  AND field != '';
```

---

### Pro Tips

1. **CSN is King**: When you have a `PAT_ENC_CSN_ID`, you can join to almost any clinical table.

2. **Check Your Dates**: Epic uses various date formats. The `_REAL` suffix indicates Epic's decimal date format (days since 12/31/1840).

3. **Provider ≠ Person**: A "provider" in Epic can be a person, department, external lab, or even equipment.

4. **The One-Day Lag**: Remember EHI data comes from Clarity, which is typically one day behind real-time.

5. **LINE Starts at 1**: Unlike array indices, LINE numbers typically start at 1, not 0.

6. **Denormalization is Normal**: Epic prioritizes query performance over normalization. You'll find patient names in encounter tables, department names in order tables, etc.

---

### Key Takeaways
1. Start simple - get patient and encounter data working first
2. Master the LINE pattern - it's everywhere in Epic
3. Understand the clinical-financial bridge (CSN ↔ HAR)
4. Always verify your joins produce expected row counts
5. These patterns work at any scale - one patient or one million

---

### Next Steps
→ Continue to Chapter 6.3: SQL Recipe Library