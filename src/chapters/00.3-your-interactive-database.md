# Chapter 0.3: Your Interactive Database

*Purpose: Understand how this manual's interactive environment works, how to explore its structure, and how to use built-in documentation to find the data you need.*

### The Engine Behind the Manual

You've already seen that you can run live SQL queries directly in this book. The magic behind this is a self-contained SQLite database file (`ehi.sqlite`) that was downloaded when you first loaded this page. This single file is a complete, portable, and queryable version of an Epic EHI export.

This chapter pulls back the curtain, showing you how this database was created and how you can use its built-in documentation to explore the thousands of tables and columns within it.

### From TSV Files to a Searchable Database

The `ehi.sqlite` database was created by:
1.  **Parsing TSV Files**: A script processed each of the hundreds of `.tsv` files from a real (redacted) Epic EHI export.
2.  **Creating Tables**: For each file (e.g., `PAT_ENC.tsv`), a corresponding SQL table (`PAT_ENC`) was created.
3.  **Ingesting Documentation**: Table and column descriptions from Epic's official data dictionary PDF were parsed and loaded into a special `_metadata` table.
4.  **Packaging**: The entire dataset and its documentation were packaged into a single `ehi.sqlite` file.

This process transforms a folder of flat files into a powerful, self-documenting relational database that you can explore entirely within your browser.

### The `_metadata` Table: Your Built-in Data Dictionary

Forget switching between a PDF and your SQL editor. We've embedded Epic's documentation directly into the database in a table called `_metadata`.

It has a simple structure:
- `table_name`: The name of the table being described.
- `column_name`: The name of the column. If this is `NULL`, the documentation is for the entire table.
- `documentation`: The description from Epic's data dictionary.

<example-query description="Get the documentation for the PATIENT table">
-- Find out what the PATIENT table is for
SELECT documentation 
FROM _metadata
WHERE table_name = 'PATIENT' 
  AND column_name IS NULL;
</example-query>

<example-query description="Get descriptions for key columns in the PATIENT table">
-- See what the most important columns in the PATIENT table mean
SELECT 
  column_name, 
  documentation
FROM _metadata
WHERE table_name = 'PATIENT' 
  AND column_name IN ('PAT_ID', 'PAT_MRN_ID', 'PAT_NAME', 'BIRTH_DATE', 'SEX_C_NAME')
ORDER BY column_name;
</example-query>

### Meta-Querying Use Cases: Finding Your Way

By querying the metadata, you can answer fundamental questions about the dataset without knowing the schema in advance.

#### Use Case 1: "Where can I find information about...?"

You need to analyze patient allergies but don't know which tables to use. This query transforms a vague question into an actionable starting point.

<example-query description="Find which tables are most relevant to allergies">
-- Search documentation and summarize by table
SELECT 
  table_name,
  COUNT(*) as relevant_columns
FROM _metadata
WHERE documentation LIKE '%allergy%'
GROUP BY table_name
ORDER BY relevant_columns DESC;
</example-query>

This instantly shows you that the `ALLERGY` and `DOCS_RCVD_ALGS` tables are your best starting points.

#### Use Case 2: "Show me all the ways to link to a patient."

You need to join a new table and want to see if it connects directly to a patient.

<example-query description="Find the first 10 tables that link directly to a patient">
-- This finds direct foreign key relationships to the PATIENT table
SELECT 
  table_name,
  documentation
FROM _metadata
WHERE column_name = 'PAT_ID'
ORDER BY table_name
LIMIT 10;
</example-query>

### Power-Up: Combining with `sqlite_master`

For a complete picture of a table's schema, you can join our `_metadata` table with SQLite's built-in `pragma_table_info` function, which provides data types.

<example-query description="Get a preview of the schema for the ORDER_PROC table">
-- Join our documentation with SQLite's schema info
SELECT 
  ti.name as column_name,
  ti.type as data_type,
  md.documentation
FROM pragma_table_info('ORDER_PROC') ti
LEFT JOIN _metadata md 
  ON ti.name = md.column_name 
  AND md.table_name = 'ORDER_PROC'
ORDER BY ti.pk
LIMIT 15;
</example-query>

### Key Takeaways

- The interactive examples in this manual are powered by a real SQLite database.
- The `_metadata` table contains the entire Epic data dictionary, making the database self-documenting.
- You can query this metadata to discover tables, understand columns, and find relationships.
- Combining `_metadata` with SQLite's built-in functions gives you a complete, explorable schema.

You are no longer just a user of the data; you are an explorer of the entire data model.
