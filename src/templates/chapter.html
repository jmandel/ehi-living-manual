<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}} - Epic EHI Missing Manual</title>
  <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
  <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
  <div class="layout">
    <!-- Header with search and controls -->
    <header class="header">
      <div class="header-content">
        <button class="menu-toggle" id="menu-toggle" aria-label="Toggle sidebar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
          </svg>
        </button>
        
        <div class="header-title">
          <a href="../index.html">Epic EHI Missing Manual</a>
        </div>
        
        <div class="search-container">
          <input type="search" 
                 class="search-input" 
                 placeholder="Search documentation... (Press '/' to focus)"
                 id="search-input"
                 aria-label="Search documentation">
          <div class="search-results" id="search-results"></div>
        </div>
        
        <a href="../playground.html" class="playground-button" title="SQL Playground">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          <span>Playground</span>
        </a>
        
        <button class="copy-button" id="copy-markdown" title="Copy chapter content for AI/LLM context">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          <span>Copy</span>
        </button>
        
        <a href="https://github.com/jmandel/ehi-missing-manual/edit/main/src/chapters/{{chapter-slug}}.md" 
           class="edit-github-button" 
           target="_blank"
           rel="noopener noreferrer"
           title="Edit this chapter on GitHub">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          <span>Edit</span>
        </a>
      </div>
    </header>
    
    <!-- Content wrapper for sidebar + main -->
    <div class="content-wrapper">
      <!-- Sidebar navigation -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Collapse sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="11 17 6 12 11 7"/>
              <polyline points="18 17 13 12 18 7"/>
            </svg>
          </button>
        </div>
        <div class="sidebar-content">
          {{navigation}}
        </div>
      </aside>
      
      <!-- Main content -->
      <main class="main-content">
        <article class="chapter">
          {{content}}
        </article>
        
        <footer class="chapter-footer">
          {{prev-next-links}}
        </footer>
      </main>
      
    </div>
    
    <footer class="site-footer">
      <p>
        © <span id="current-year"></span> Epic EHI Missing Manual • 
        <a href="https://github.com/jmandel/ehi-missing-manual">Contribute on GitHub</a>
      </p>
    </footer>
  </div>
  
  <!-- SQL.js for interactive queries -->
  <script src="../lib/sql.js/sql-wasm.js"></script>
  <script src="../assets/js/sql-widget.js"></script>
  
  <!-- Search functionality -->
  <script src="../lib/fuse.min.js"></script>
  <script src="../assets/js/search.js"></script>
  
  <!-- Mermaid for diagrams -->
  <script src="../lib/mermaid.min.js"></script>
  
  <!-- Navigation and UI interactions -->
  <script>
    // Initialize Mermaid
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        rankSpacing: 80,
        nodeSpacing: 30,
        curve: 'basis'
      },
      themeVariables: {
        primaryColor: '#5865f2',
        primaryTextColor: '#e6edf3',
        primaryBorderColor: '#30363d',
        lineColor: '#8b949e',
        secondaryColor: '#161b22',
        tertiaryColor: '#1f242b',
        background: '#0d1117',
        mainBkg: '#161b22',
        secondBkg: '#1f242b',
        tertiaryBkg: '#0d1117',
        primaryBorderColor: '#30363d',
        secondaryBorderColor: '#21262d',
        tertiaryBorderColor: '#30363d',
        noteBorderColor: '#30363d',
        noteBkgColor: '#161b22',
        noteTextColor: '#e6edf3',
        actorBorder: '#30363d',
        actorBkg: '#161b22',
        actorTextColor: '#e6edf3',
        actorLineColor: '#8b949e',
        labelBoxBkgColor: '#161b22',
        labelBoxBorderColor: '#30363d',
        labelTextColor: '#e6edf3',
        loopTextColor: '#e6edf3',
        activationBorderColor: '#5865f2',
        activationBkgColor: '#1f242b',
        sequenceNumberColor: '#0d1117'
      }
    });
    
    // Function to switch mermaid tabs
    window.showMermaidTab = function(mermaidId, tab) {
      const widget = document.getElementById(`widget-${mermaidId}`);
      const diagramDiv = document.getElementById(`diagram-${mermaidId}`);
      const codeDiv = document.getElementById(`code-${mermaidId}`);
      const tabs = widget.querySelectorAll('.mermaid-tab');
      
      tabs.forEach(t => t.classList.remove('active'));
      
      if (tab === 'diagram') {
        diagramDiv.style.display = 'block';
        codeDiv.style.display = 'none';
        tabs[0].classList.add('active');
      } else {
        diagramDiv.style.display = 'none';
        codeDiv.style.display = 'block';
        tabs[1].classList.add('active');
      }
    };
    
    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const layout = document.querySelector('.layout');
    
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('sidebar-open');
      layout.classList.toggle('sidebar-open');
    });
    
    // Sidebar collapse toggle
    const sidebarToggle = document.getElementById('sidebar-toggle');
    
    // Check for saved sidebar state
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    const mainContent = document.querySelector('.main-content');
    if (sidebarCollapsed) {
      sidebar.classList.add('collapsed');
      mainContent.style.marginLeft = '0';
    }
    
    sidebarToggle.addEventListener('click', () => {
      const isCollapsed = sidebar.classList.toggle('collapsed');
      const mainContent = document.querySelector('.main-content');
      if (isCollapsed) {
        mainContent.style.marginLeft = '0';
      } else {
        mainContent.style.marginLeft = '';
      }
      localStorage.setItem('sidebarCollapsed', isCollapsed);
    });
    
    // Search functionality (placeholder - will be implemented with Fuse.js)
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    
    // Focus search on '/' key
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
    });
    
    // Set current year in footer
    document.getElementById('current-year').textContent = new Date().getFullYear();
    
    // Update GitHub edit link with correct chapter slug
    const currentPath = window.location.pathname;
    const chapterSlug = currentPath.split('/').pop().replace('.html', '');
    const editLink = document.querySelector('.edit-github-button');
    if (editLink) {
      editLink.href = `https://github.com/jmandel/ehi-missing-manual/edit/main/src/chapters/${chapterSlug}.md`;
    }
    
    // Copy markdown functionality
    const copyButton = document.getElementById('copy-markdown');
    copyButton.addEventListener('click', async () => {
      try {
        // Get the current chapter filename from the URL
        const currentPath = window.location.pathname;
        const chapterSlug = currentPath.split('/').pop().replace('.html', '');
        const markdownPath = `../assets/markdown/${chapterSlug}.md`;
        
        // Fetch the markdown content
        const response = await fetch(markdownPath);
        if (!response.ok) throw new Error('Failed to fetch markdown');
        
        const markdown = await response.text();
        
        // Copy to clipboard
        await navigator.clipboard.writeText(markdown);
        
        // Update button temporarily
        const originalHTML = copyButton.innerHTML;
        copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>';
        copyButton.style.color = 'var(--success)';
        
        setTimeout(() => {
          copyButton.innerHTML = originalHTML;
          copyButton.style.color = '';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy markdown:', error);
        const originalHTML = copyButton.innerHTML;
        copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><span>Failed</span>';
        copyButton.style.color = 'var(--danger)';
        setTimeout(() => {
          copyButton.innerHTML = originalHTML;
          copyButton.style.color = '';
        }, 2000);
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
      
      if (e.key === 'j' || e.key === 'ArrowLeft') {
        const prevLink = document.querySelector('.prev-link:not(.disabled)');
        if (prevLink) prevLink.click();
      } else if (e.key === 'k' || e.key === 'ArrowRight') {
        const nextLink = document.querySelector('.next-link:not(.disabled)');
        if (nextLink) nextLink.click();
      }
    });
  </script>
</body>
</html>