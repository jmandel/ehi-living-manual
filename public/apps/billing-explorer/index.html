<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Financial Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .dashboard-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .patient-name {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .patient-info {
            color: #666;
            margin-top: 5px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: 600;
        }
        
        .positive {
            color: #27ae60;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* Timeline styles */
        .timeline-item {
            cursor: pointer;
        }
        
        .timeline-item:hover {
            opacity: 0.8;
        }
        
        .timeline-tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Sankey styles */
        .sankey-link {
            fill: none;
            stroke-opacity: 0.5;
        }
        
        .sankey-link:hover {
            stroke-opacity: 0.8;
        }
        
        .sankey-node rect {
            cursor: pointer;
        }
        
        .sankey-node text {
            font-size: 12px;
            fill: #333;
        }
        
        /* Department chart styles */
        .bar {
            cursor: pointer;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        /* Monthly trend styles */
        .trend-line {
            fill: none;
            stroke-width: 2;
        }
        
        .trend-area {
            opacity: 0.3;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Coverage timeline */
        .coverage-bar {
            cursor: pointer;
        }
        
        .coverage-bar:hover {
            opacity: 0.8;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        /* Workflow Audit Trail styles */
        .workflow-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .workflow-stat {
            text-align: center;
        }
        
        .workflow-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .workflow-stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .workflow-event {
            cursor: pointer;
        }
        
        .workflow-event:hover {
            opacity: 0.8;
        }
        
        .workflow-link {
            stroke: #999;
            stroke-opacity: 0.6;
            fill: none;
        }
        
        .workflow-user-label {
            font-size: 10px;
            fill: #666;
        }
        
        .workflow-tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading financial data...</div>
    <div id="dashboard" style="display: none;">
        <div class="dashboard-header">
            <h1 class="patient-name" id="patientName"></h1>
            <div class="patient-info" id="patientInfo"></div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Financial Summary Card -->
            <div class="card">
                <h2 class="card-title">Financial Summary</h2>
                <div id="financialSummary"></div>
            </div>
            
            <!-- Insurance Coverage Card -->
            <div class="card">
                <h2 class="card-title">Insurance Coverage</h2>
                <div id="insuranceCoverage"></div>
            </div>
            
            <!-- Recent Activity Card -->
            <div class="card">
                <h2 class="card-title">Recent Activity</h2>
                <div id="recentActivity"></div>
            </div>
        </div>
        
        <!-- Timeline Visualization -->
        <div class="card full-width">
            <h2 class="card-title">Healthcare Journey Timeline</h2>
            <div id="timeline"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Encounters</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Charges</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Claims</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #27ae60;"></div>
                    <span>Payments</span>
                </div>
            </div>
        </div>
        
        <!-- Financial Flow Sankey Diagram -->
        <div class="card full-width">
            <h2 class="card-title">Financial Flow</h2>
            <div id="sankey"></div>
        </div>
        
        <!-- Workflow Audit Trail -->
        <div class="card full-width">
            <h2 class="card-title">Workflow Audit Trail</h2>
            <div class="workflow-summary" id="workflowSummary"></div>
            <div id="workflowTimeline"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Encounter</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Charge</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #27ae60;"></div>
                    <span>Payment</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>Adjustment</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Claim</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #1abc9c;"></div>
                    <span>Verification</span>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Department Analysis -->
            <div class="card">
                <h2 class="card-title">Charges by Department</h2>
                <div id="departmentChart"></div>
            </div>
            
            <!-- Monthly Trends -->
            <div class="card">
                <h2 class="card-title">Monthly Trends</h2>
                <div id="monthlyTrends"></div>
            </div>
        </div>
        
        <!-- Encounter Summary -->
        <div class="card full-width">
            <h2 class="card-title">Encounter Summary</h2>
            <div id="encounterSummary" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- Encounter Details -->
        <div class="card full-width">
            <h2 class="card-title">Encounter Details</h2>
            <div id="encounterTable"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let patientData = null;
        const formatCurrency = d3.format("$,.2f");
        const formatDate = d3.timeFormat("%b %d, %Y");
        const parseDate = d3.timeParse("%m/%d/%Y %I:%M:%S %p");
        
        // Color schemes
        const colors = {
            encounter: "#3498db",
            charge: "#e74c3c",
            claim: "#f39c12",
            payment: "#27ae60",
            adjustment: "#9b59b6"
        };
        
        // Load the data
        async function loadData() {
            try {
                const response = await fetch('patient_financial_data.json');
                const data = await response.json();
                patientData = data[0]; // Assume first patient for now
                
                // Parse dates
                if (patientData.timeline) {
                    patientData.timeline.forEach(d => {
                        d.parsedDate = parseDate(d.date);
                    });
                }
                
                if (patientData.encounters) {
                    patientData.encounters.forEach(d => {
                        d.parsedDate = parseDate(d.encounterDate);
                    });
                }
                
                // Hide loading, show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Render all components
                renderHeader();
                renderFinancialSummary();
                renderInsuranceCoverage();
                renderRecentActivity();
                renderTimeline();
                renderSankey();
                renderWorkflowAuditTrail();
                renderDepartmentChart();
                renderMonthlyTrends();
                renderEncounterSummary();
                renderEncounterTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 'Error loading data. Please check the console.';
            }
        }
        
        function renderHeader() {
            document.getElementById('patientName').textContent = patientData.patientName;
            document.getElementById('patientInfo').textContent = 
                `Patient ID: ${patientData.patientId} | Guarantor: ${patientData.guarantor.accountName}`;
        }
        
        function renderFinancialSummary() {
            const summary = patientData.financialSummary;
            const summaryHtml = `
                <div class="metric">
                    <span class="metric-label">Total Charges</span>
                    <span class="metric-value">${formatCurrency(summary.totalCharges)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Payments</span>
                    <span class="metric-value positive">${formatCurrency(summary.totalPayments)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Insurance Payments</span>
                    <span class="metric-value">${formatCurrency(summary.totalInsurancePayments)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Patient Payments</span>
                    <span class="metric-value">${formatCurrency(summary.totalPatientPayments)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Outstanding Balance</span>
                    <span class="metric-value ${summary.outstandingBalance > 0 ? 'negative' : 'positive'}">
                        ${formatCurrency(Math.abs(summary.outstandingBalance))}
                    </span>
                </div>
            `;
            document.getElementById('financialSummary').innerHTML = summaryHtml;
        }
        
        function renderInsuranceCoverage() {
            const coverages = patientData.coverages;
            let coverageHtml = '';
            
            coverages.forEach(coverage => {
                const member = coverage.members[0];
                coverageHtml += `
                    <div class="metric">
                        <div>
                            <div style="font-weight: 600;">${coverage.payorName || 'Unknown Payer'}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${coverage.planName || 'Unknown Plan'}<br>
                                Member #: ${member?.memberNumber || 'N/A'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('insuranceCoverage').innerHTML = coverageHtml;
        }
        
        function renderRecentActivity() {
            const recentEvents = patientData.timeline ? 
                patientData.timeline.slice(-5).reverse() : [];
            
            let activityHtml = '';
            recentEvents.forEach(event => {
                const icon = event.type === 'payment' ? '‚úì' : 
                           event.type === 'charge' ? '$' :
                           event.type === 'encounter' ? 'üè•' : 'üìÑ';
                
                activityHtml += `
                    <div class="metric">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${icon}</span>
                            <div>
                                <div style="font-weight: 500;">${event.description}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${formatDate(event.parsedDate)}
                                    ${event.amount ? ' - ' + formatCurrency(event.amount) : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('recentActivity').innerHTML = activityHtml || 
                '<div style="text-align: center; color: #666;">No recent activity</div>';
        }
        
        function renderTimeline() {
            const container = d3.select("#timeline");
            const width = container.node().getBoundingClientRect().width - 40;
            const height = 200;
            const margin = { top: 20, right: 20, bottom: 40, left: 20 };
            
            // Clear previous content
            container.selectAll("*").remove();
            
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Use enhanced encounters for timeline to match the encounter list
            const enhancedEncounters = patientData.enhancedEncounters || [];
            const encounterIds = new Set(enhancedEncounters.map(e => e.encounterId));
            
            // Filter timeline events to only include encounters that are in the enhanced list
            let events = patientData.timeline || [];
            events = events.filter(e => {
                if (e.type === 'encounter') {
                    return encounterIds.has(e.encounterId);
                }
                return true; // Keep all non-encounter events
            });
            
            if (events.length === 0) return;
            
            // X scale
            const xScale = d3.scaleTime()
                .domain(d3.extent(events, d => d.parsedDate))
                .range([0, innerWidth]);
            
            // Y scale by event type
            const yScale = d3.scaleOrdinal()
                .domain(['encounter', 'charge', 'claim', 'payment', 'adjustment'])
                .range([20, 50, 80, 110, 140]);
            
            // X axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat("%b %Y")));
            
            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "timeline-tooltip")
                .style("opacity", 0);
            
            // Add events
            g.selectAll(".timeline-item")
                .data(events)
                .enter().append("circle")
                .attr("class", "timeline-item")
                .attr("cx", d => xScale(d.parsedDate))
                .attr("cy", d => yScale(d.type))
                .attr("r", d => d.amount ? Math.sqrt(d.amount / 50) + 3 : 5)
                .attr("fill", d => colors[d.type])
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`
                        <strong>${d.description}</strong><br/>
                        ${formatDate(d.parsedDate)}<br/>
                        ${d.amount ? formatCurrency(d.amount) : ''}
                        ${d.department ? '<br/>' + d.department : ''}
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
            
            // Add type labels
            const typeLabels = ['Encounters', 'Charges', 'Claims', 'Payments'];
            g.selectAll(".type-label")
                .data(typeLabels)
                .enter().append("text")
                .attr("class", "type-label")
                .attr("x", -10)
                .attr("y", (d, i) => [20, 50, 80, 110][i])
                .attr("text-anchor", "end")
                .attr("alignment-baseline", "middle")
                .style("font-size", "11px")
                .style("fill", "#666")
                .text(d => d);
        }
        
        function renderSankey() {
            const container = d3.select("#sankey");
            const width = container.node().getBoundingClientRect().width - 40;
            const height = 400;
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };
            
            // Clear previous content
            container.selectAll("*").remove();
            
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Prepare sankey data
            const flows = patientData.financialFlows || [];
            
            // Create nodes from flows
            const nodeNames = new Set();
            flows.forEach(f => {
                nodeNames.add(f.source);
                nodeNames.add(f.target);
            });
            
            const nodes = Array.from(nodeNames).map(name => ({ name }));
            const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
            
            const links = flows.map(f => ({
                source: nodeMap.get(f.source),
                target: nodeMap.get(f.target),
                value: f.value,
                type: f.type
            }));
            
            // Create sankey layout with custom positioning for 4-column flow
            const sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(15)
                .nodeAlign(d3.sankeyJustify)
                .iterations(64)
                .extent([[0, 0], [innerWidth, innerHeight]]);
            
            const graph = sankey({
                nodes: nodes.map(d => Object.assign({}, d)),
                links: links.map(d => Object.assign({}, d))
            });
            
            // Add links
            g.append("g")
                .selectAll(".sankey-link")
                .data(graph.links)
                .enter().append("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", d => {
                    if (d.type === 'charge') return colors.charge;
                    if (d.type === 'payment') return colors.payment;
                    if (d.type === 'adjustment') return colors.adjustment;
                    if (d.type === 'outstanding') return "#e67e22";
                    return "#999";
                })
                .attr("stroke-width", d => Math.max(1, d.width))
                .append("title")
                .text(d => `${d.source.name} ‚Üí ${d.target.name}: ${formatCurrency(d.value)}`);
            
            // Add nodes
            const node = g.append("g")
                .selectAll(".sankey-node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "sankey-node");
            
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", "#2c3e50")
                .append("title")
                .text(d => `${d.name}: ${formatCurrency(d.value)}`);
            
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name);
        }
        
        function renderWorkflowAuditTrail() {
            // Render summary statistics
            const summary = patientData.workflowSummary;
            const events = patientData.workflowAuditTrail || [];
            
            if (!summary || !events || events.length === 0) {
                document.getElementById('workflowSummary').innerHTML = 
                    '<div style="text-align: center; color: #666;">No workflow data available</div>';
                document.getElementById('workflowTimeline').innerHTML = '';
                return;
            }
            
            // Render summary
            const summaryHtml = `
                <div class="workflow-stat">
                    <div class="workflow-stat-value">${summary.totalSteps}</div>
                    <div class="workflow-stat-label">Total Steps</div>
                </div>
                <div class="workflow-stat">
                    <div class="workflow-stat-value">${summary.uniqueUsers}</div>
                    <div class="workflow-stat-label">Unique Users</div>
                </div>
                <div class="workflow-stat">
                    <div class="workflow-stat-value">${summary.averageStepDuration}</div>
                    <div class="workflow-stat-label">Avg Minutes/Step</div>
                </div>
                <div class="workflow-stat">
                    <div class="workflow-stat-value">${summary.departmentsInvolved.length}</div>
                    <div class="workflow-stat-label">Departments</div>
                </div>
                <div class="workflow-stat">
                    <div class="workflow-stat-value">${summary.totalDuration}</div>
                    <div class="workflow-stat-label">Total Days</div>
                </div>
            `;
            document.getElementById('workflowSummary').innerHTML = summaryHtml;
            
            // Group events by category for stacked bar visualization
            const container = d3.select("#workflowTimeline");
            const width = container.node().getBoundingClientRect().width - 40;
            const height = 600;
            const margin = { top: 20, right: 200, bottom: 80, left: 200 };
            
            // Clear previous content
            container.selectAll("*").remove();
            
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Parse timestamps
            events.forEach(e => {
                e.parsedTime = new Date(e.timestamp);
            });
            
            // Group events by user and category
            const userTaskSummary = d3.rollup(events, 
                v => v.length,
                d => d.userName || d.userId,
                d => d.category
            );
            
            // Convert to array format for stacking
            const users = Array.from(userTaskSummary.keys()).sort((a, b) => {
                const aTotal = d3.sum(Array.from(userTaskSummary.get(a).values()));
                const bTotal = d3.sum(Array.from(userTaskSummary.get(b).values()));
                return bTotal - aTotal; // Sort by total actions descending
            });
            
            const categories = ['encounter', 'charge', 'payment', 'adjustment', 'claim', 'verification'];
            
            const data = users.map(user => {
                const tasks = userTaskSummary.get(user);
                const row = { user };
                categories.forEach(cat => {
                    row[cat] = tasks.get(cat) || 0;
                });
                row.total = d3.sum(categories, cat => row[cat]);
                return row;
            });
            
            // Color scale for categories
            const categoryColors = {
                encounter: "#3498db",
                charge: "#e74c3c",
                payment: "#27ae60",
                adjustment: "#9b59b6",
                claim: "#f39c12",
                verification: "#1abc9c"
            };
            
            // Scales
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.total)])
                .range([0, innerWidth]);
            
            const yScale = d3.scaleBand()
                .domain(users)
                .range([0, innerHeight])
                .padding(0.1);
            
            // Stack the data
            const stack = d3.stack()
                .keys(categories)
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);
            
            const series = stack(data);
            
            // Create bars
            const barGroups = g.selectAll(".bar-group")
                .data(series)
                .enter().append("g")
                .attr("class", "bar-group")
                .attr("fill", d => categoryColors[d.key]);
            
            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "workflow-tooltip")
                .style("opacity", 0);
            
            barGroups.selectAll("rect")
                .data(d => d)
                .enter().append("rect")
                .attr("y", d => yScale(d.data.user))
                .attr("x", d => xScale(d[0]))
                .attr("width", d => xScale(d[1]) - xScale(d[0]))
                .attr("height", yScale.bandwidth())
                .on("mouseover", function(event, d) {
                    const category = d3.select(this.parentNode).datum().key;
                    const count = d[1] - d[0];
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`
                        <strong>${d.data.user}</strong><br/>
                        ${category}: ${count} actions<br/>
                        Total: ${d.data.total} actions
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
            
            // X axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale))
                .append("text")
                .attr("x", innerWidth / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .text("Number of Actions");
            
            // Y axis
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(yScale));
            
            // Legend
            const legend = svg.append("g")
                .attr("transform", `translate(${width - margin.right + 20}, ${margin.top})`);
            
            legend.append("text")
                .attr("x", 0)
                .attr("y", -5)
                .style("font-weight", "600")
                .style("font-size", "12px")
                .text("Action Types");
            
            categories.forEach((cat, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20 + 10})`);
                
                legendRow.append("rect")
                    .attr("width", 16)
                    .attr("height", 16)
                    .attr("fill", categoryColors[cat]);
                
                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .style("font-size", "12px")
                    .text(cat.charAt(0).toUpperCase() + cat.slice(1));
            });
            
            // Add task breakdown below
            const taskBreakdown = container.append("div")
                .style("margin-top", "20px")
                .style("display", "grid")
                .style("grid-template-columns", "repeat(auto-fit, minmax(300px, 1fr))")
                .style("gap", "15px");
            
            // Group by category to show most common tasks
            categories.forEach(cat => {
                const catEvents = events.filter(e => e.category === cat);
                if (catEvents.length === 0) return;
                
                const taskCounts = d3.rollup(catEvents, v => v.length, d => d.action);
                const topTasks = Array.from(taskCounts.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const catCard = taskBreakdown.append("div")
                    .attr("class", "card")
                    .style("padding", "15px");
                
                catCard.append("h4")
                    .style("margin", "0 0 10px 0")
                    .style("color", categoryColors[cat])
                    .text(cat.charAt(0).toUpperCase() + cat.slice(1) + " Actions");
                
                topTasks.forEach(([task, count]) => {
                    catCard.append("div")
                        .style("display", "flex")
                        .style("justify-content", "space-between")
                        .style("padding", "5px 0")
                        .style("border-bottom", "1px solid #eee")
                        .html(`
                            <span style="font-size: 12px;">${task}</span>
                            <span style="font-weight: 600; font-size: 12px;">${count}</span>
                        `);
                });
            });
        }
        
        function renderDepartmentChart() {
            const container = d3.select("#departmentChart");
            const width = container.node().getBoundingClientRect().width - 40;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 100, left: 60 };
            
            // Clear previous content
            container.selectAll("*").remove();
            
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Get department data
            const deptData = patientData.departmentSummaries || [];
            const topDepts = deptData.slice(0, 8); // Top 8 departments
            
            // Scales
            const xScale = d3.scaleBand()
                .domain(topDepts.map(d => d.departmentName))
                .range([0, innerWidth])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(topDepts, d => d.totalCharges)])
                .nice()
                .range([innerHeight, 0]);
            
            // Axes
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
            
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(yScale)
                    .tickFormat(d => formatCurrency(d)));
            
            // Bars
            g.selectAll(".bar")
                .data(topDepts)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => xScale(d.departmentName))
                .attr("y", d => yScale(d.totalCharges))
                .attr("width", xScale.bandwidth())
                .attr("height", d => innerHeight - yScale(d.totalCharges))
                .attr("fill", colors.charge)
                .append("title")
                .text(d => `${d.departmentName}\nCharges: ${formatCurrency(d.totalCharges)}\nVisits: ${d.visitCount}`);
            
            // Y axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (innerHeight / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .text("Total Charges");
        }
        
        function renderMonthlyTrends() {
            const container = d3.select("#monthlyTrends");
            const width = container.node().getBoundingClientRect().width - 40;
            const height = 300;
            const margin = { top: 20, right: 60, bottom: 40, left: 60 };
            
            // Clear previous content
            container.selectAll("*").remove();
            
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Get monthly data
            const monthlyData = patientData.monthlySummaries || [];
            
            // Parse month strings to dates
            monthlyData.forEach(d => {
                d.date = d3.timeParse("%Y-%m")(d.month);
            });
            
            // Scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(monthlyData, d => d.date))
                .range([0, innerWidth]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(monthlyData, d => Math.max(d.charges, d.payments))])
                .nice()
                .range([innerHeight, 0]);
            
            // Line generators
            const chargeLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.charges))
                .curve(d3.curveMonotoneX);
            
            const paymentLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.payments))
                .curve(d3.curveMonotoneX);
            
            // Axes
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat("%b %y")));
            
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(yScale)
                    .tickFormat(d => formatCurrency(d)));
            
            // Area under charges
            const chargeArea = d3.area()
                .x(d => xScale(d.date))
                .y0(innerHeight)
                .y1(d => yScale(d.charges))
                .curve(d3.curveMonotoneX);
            
            g.append("path")
                .datum(monthlyData)
                .attr("class", "trend-area")
                .attr("d", chargeArea)
                .attr("fill", colors.charge);
            
            // Lines
            g.append("path")
                .datum(monthlyData)
                .attr("class", "trend-line")
                .attr("d", chargeLine)
                .attr("stroke", colors.charge);
            
            g.append("path")
                .datum(monthlyData)
                .attr("class", "trend-line")
                .attr("d", paymentLine)
                .attr("stroke", colors.payment);
            
            // Legend
            const legend = g.append("g")
                .attr("transform", `translate(${innerWidth - 100}, 20)`);
            
            legend.append("line")
                .attr("x1", 0)
                .attr("x2", 20)
                .attr("y1", 0)
                .attr("y2", 0)
                .attr("stroke", colors.charge)
                .attr("stroke-width", 2);
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 0)
                .attr("alignment-baseline", "middle")
                .style("font-size", "12px")
                .text("Charges");
            
            legend.append("line")
                .attr("x1", 0)
                .attr("x2", 20)
                .attr("y1", 20)
                .attr("y2", 20)
                .attr("stroke", colors.payment)
                .attr("stroke-width", 2);
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 20)
                .attr("alignment-baseline", "middle")
                .style("font-size", "12px")
                .text("Payments");
            
            // Y axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (innerHeight / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .text("Amount ($)");
        }
        
        function renderEncounterSummary() {
            const encounters = patientData.enhancedEncounters || [];
            const totalEncounters = encounters.length;
            const totalCharges = encounters.reduce((sum, enc) => sum + enc.charges, 0);
            const totalPayments = encounters.reduce((sum, enc) => sum + enc.payments, 0);
            const totalBalance = encounters.reduce((sum, enc) => sum + enc.balance, 0);
            const unpaidEncounters = encounters.filter(enc => enc.balance > 0).length;
            
            const summaryHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #3498db;">${totalEncounters}</div>
                        <div style="color: #666; margin-top: 5px;">Total Encounters</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #e74c3c;">${formatCurrency(totalCharges)}</div>
                        <div style="color: #666; margin-top: 5px;">Total Charges</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #27ae60;">${formatCurrency(totalPayments)}</div>
                        <div style="color: #666; margin-top: 5px;">Total Payments</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: ${totalBalance > 0 ? '#e74c3c' : '#27ae60'};">${formatCurrency(Math.abs(totalBalance))}</div>
                        <div style="color: #666; margin-top: 5px;">Outstanding Balance</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">${unpaidEncounters}</div>
                        <div style="color: #666; margin-top: 5px;">Unpaid Encounters</div>
                    </div>
                </div>
            `;
            
            document.getElementById('encounterSummary').innerHTML = summaryHtml;
        }
        
        function renderEncounterTable() {
            const encounters = patientData.enhancedEncounters || [];
            const totalEncounters = encounters.length;
            
            // Group encounters by date for better organization
            const encountersByMonth = {};
            encounters.forEach(enc => {
                const date = new Date(enc.encounterDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!encountersByMonth[monthKey]) {
                    encountersByMonth[monthKey] = [];
                }
                encountersByMonth[monthKey].push(enc);
            });
            
            // Within each month, group same-day encounters
            Object.keys(encountersByMonth).forEach(monthKey => {
                const monthEncounters = encountersByMonth[monthKey];
                const groupedByDay = {};
                
                monthEncounters.forEach(enc => {
                    const dateKey = enc.encounterDate.split(' ')[0]; // Get just the date part
                    if (!groupedByDay[dateKey]) {
                        groupedByDay[dateKey] = [];
                    }
                    groupedByDay[dateKey].push(enc);
                });
                
                // Replace month encounters with grouped version
                encountersByMonth[monthKey] = Object.values(groupedByDay);
            });
            
            let tableHtml = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; margin: 0;">Total: ${totalEncounters} encounters</p>
                </div>
            `;
            
            // Sort months in reverse chronological order
            const sortedMonths = Object.keys(encountersByMonth).sort().reverse();
            
            sortedMonths.forEach(monthKey => {
                const monthEncounters = encountersByMonth[monthKey];
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                tableHtml += `
                    <div style="margin-top: 30px; margin-bottom: 15px;">
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;">${monthName}</h3>
                    </div>
                `;
                
                // monthEncounters is now an array of day groups
                monthEncounters.forEach(dayGroup => {
                    // Aggregate same-day encounters
                    const totalCharges = dayGroup.reduce((sum, enc) => sum + enc.charges, 0);
                    const totalPayments = dayGroup.reduce((sum, enc) => sum + enc.payments, 0);
                    const totalBalance = dayGroup.reduce((sum, enc) => sum + enc.balance, 0);
                    const hasCharges = totalCharges > 0;
                    const backgroundColor = totalBalance > 0 ? '#fff5f5' : (hasCharges ? '#f0f9ff' : '#ffffff');
                    
                    // Collect all departments and services
                    const departments = [...new Set(dayGroup.map(enc => enc.departmentName).filter(d => d))];
                    const allProcedures = dayGroup.flatMap(enc => enc.procedures || []);
                    const allDiagnoses = dayGroup.flatMap(enc => enc.diagnoses || []);
                    const allProviders = dayGroup.flatMap(enc => enc.providers || []);
                    const allLabs = dayGroup.flatMap(enc => enc.labs || []);
                    
                    // Use first encounter for date and basic info
                    const firstEnc = dayGroup[0];
                    
                    tableHtml += `
                        <div style="background-color: ${backgroundColor}; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">
                                        ${formatDate(parseDate(firstEnc.encounterDate))}${dayGroup.length > 1 ? ` - ${dayGroup.length} visits` : ''}
                                    </h4>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                        ${departments.join(', ')}
                                    </div>
                                    ${allProcedures.length > 0 || allDiagnoses.length > 0 || allProviders.length > 0 || allLabs.length > 0 ? `
                                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                                            ${allProcedures.length > 0 ? `<strong>Services:</strong> ${[...new Set(allProcedures)].join(', ')}<br>` : ''}
                                            ${allDiagnoses.length > 0 ? `<strong>Diagnoses:</strong> ${[...new Set(allDiagnoses)].join(', ')}<br>` : ''}
                                            ${allLabs.length > 0 ? `<strong>Lab Tests:</strong> ${[...new Set(allLabs)].join(', ')}<br>` : ''}
                                            ${allProviders.length > 0 ? `<strong>Providers:</strong> ${[...new Set(allProviders)].join(', ')}` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="text-align: right;">
                                    ${hasCharges ? `
                                        <div style="margin-bottom: 8px;">
                                            <span style="color: #666;">Charges:</span>
                                            <span style="font-size: 18px; font-weight: 600; color: #e74c3c; margin-left: 10px;">
                                                ${formatCurrency(totalCharges)}
                                            </span>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <span style="color: #666;">Payments:</span>
                                            <span style="font-size: 18px; font-weight: 600; color: #27ae60; margin-left: 10px;">
                                                ${formatCurrency(totalPayments)}
                                            </span>
                                        </div>
                                        <div style="padding-top: 8px; border-top: 1px solid #ddd;">
                                            <span style="color: #666;">Balance:</span>
                                            <span style="font-size: 20px; font-weight: 600; color: ${totalBalance > 0 ? '#e74c3c' : '#27ae60'}; margin-left: 10px;">
                                                ${formatCurrency(totalBalance)}
                                            </span>
                                        </div>
                                    ` : `
                                        <div style="color: #666; font-style: italic;">
                                            No charges recorded
                                        </div>
                                    `}
                                    <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                        ${firstEnc.daysSinceEncounter} days ago
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
            
            document.getElementById('encounterTable').innerHTML = tableHtml;
        }
        
        // Initialize dashboard
        loadData();
    </script>
</body>
</html>